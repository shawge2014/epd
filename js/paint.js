class PaintManager{constructor(t,e){this.canvas=t,this.ctx=e,this.painting=!1,this.lastX=0,this.lastY=0,this.brushColor="#000000",this.brushSize=2,this.currentTool=null,this.textElements=[],this.lineSegments=[],this.isTextPlacementMode=!1,this.draggingCanvasContext=null,this.selectedTextElement=null,this.isDraggingText=!1,this.dragOffsetX=0,this.dragOffsetY=0,this.textBold=!1,this.textItalic=!1,this.scheduleData=null,this.scheduleDays=5,this.scheduleClasses=6,this.scheduleFontSize=12,this.scheduleStartX=20,this.scheduleStartY=20,this.scheduleCellWidth=60,this.scheduleCellHeight=35,this.weekDays=["周一","周二","周三","周四","周五","周六","周日"],this.selectedScheduleCell=null,this.todoData=null,this.todoCount=8,this.todoFontSize=12,this.todoStartX=20,this.todoStartY=20,this.todoRowHeight=28,this.todoTitleText="待办事项",this.todoTitleAreaHeight=24,this.cardData=null,this.wifiData=null,this.pcfFontsLoaded=!1,this.weekdayFontName="wenquanyi_12pt",this.courseFontName="wenquanyi_9pt",this.brushCursor=null,this.historyStack=[],this.historyStep=-1,this.MAX_HISTORY=50,this.startPaint=this.startPaint.bind(this),this.paint=this.paint.bind(this),this.endPaint=this.endPaint.bind(this),this.handleCanvasClick=this.handleCanvasClick.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.handleKeyboard=this.handleKeyboard.bind(this),this.updateBrushCursor=this.updateBrushCursor.bind(this),this.hideBrushCursor=this.hideBrushCursor.bind(this)}saveToHistory(){this.historyStack=this.historyStack.slice(0,this.historyStep+1);var t={imageData:this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),textElements:JSON.parse(JSON.stringify(this.textElements)),lineSegments:JSON.parse(JSON.stringify(this.lineSegments)),scheduleData:this.scheduleData?JSON.parse(JSON.stringify(this.scheduleData)):null,scheduleDays:this.scheduleDays,scheduleClasses:this.scheduleClasses,scheduleFontSize:this.scheduleFontSize,todoData:this.todoData?JSON.parse(JSON.stringify(this.todoData)):null,todoCount:this.todoCount,todoFontSize:this.todoFontSize,cardData:this.cardData?JSON.parse(JSON.stringify(this.cardData)):null,wifiData:this.wifiData?JSON.parse(JSON.stringify(this.wifiData)):null};this.historyStack.push(t),this.historyStep++,this.historyStack.length>this.MAX_HISTORY&&(this.historyStack.shift(),this.historyStep--),this.updateUndoRedoButtons()}clearHistory(){this.historyStack=[],this.historyStep=-1,this.updateUndoRedoButtons()}undo(){0<this.historyStep&&(this.historyStep--,this.restoreFromHistory())}redo(){this.historyStep<this.historyStack.length-1&&(this.historyStep++,this.restoreFromHistory())}restoreFromHistory(){var t;0<=this.historyStep&&this.historyStep<this.historyStack.length&&(t=this.historyStack[this.historyStep],this.ctx.putImageData(t.imageData,0,0),this.textElements=JSON.parse(JSON.stringify(t.textElements)),this.lineSegments=JSON.parse(JSON.stringify(t.lineSegments)),t.scheduleData?(this.scheduleData=JSON.parse(JSON.stringify(t.scheduleData)),this.scheduleDays=t.scheduleDays,this.scheduleClasses=t.scheduleClasses,this.scheduleFontSize=t.scheduleFontSize):this.scheduleData=null,t.todoData?(this.todoData=JSON.parse(JSON.stringify(t.todoData)),this.todoCount=t.todoCount,this.todoFontSize=t.todoFontSize,this.calculateTodoDimensions()):this.todoData=null,t.cardData?this.cardData=JSON.parse(JSON.stringify(t.cardData)):this.cardData=null,t.wifiData?this.wifiData=JSON.parse(JSON.stringify(t.wifiData)):this.wifiData=null,this.updateUndoRedoButtons())}updateUndoRedoButtons(){var t=document.getElementById("undo-btn"),e=document.getElementById("redo-btn");t&&(t.disabled=this.historyStep<=0),e&&(e.disabled=this.historyStep>=this.historyStack.length-1)}async loadPCFFonts(){if(this.pcfFontsLoaded)return!0;try{return await pcfFontManager.load(this.weekdayFontName,"font/wenquanyi_12ptb.pcf"),await pcfFontManager.load(this.courseFontName,"font/wenquanyi_9ptb.pcf"),this.pcfFontsLoaded=!0}catch(t){return console.error("Failed to load PCF fonts:",t),this.pcfFontsLoaded=!1}}initPaintTools(){document.getElementById("brush-mode").addEventListener("click",()=>{"brush"===this.currentTool?this.setActiveTool(null,""):(this.setActiveTool("brush","画笔模式"),this.brushColor=document.getElementById("brush-color").value)}),document.getElementById("eraser-mode").addEventListener("click",()=>{"eraser"===this.currentTool?this.setActiveTool(null,""):(this.setActiveTool("eraser","橡皮擦"),this.brushColor="#FFFFFF")}),document.getElementById("text-mode").addEventListener("click",()=>{"text"===this.currentTool?this.setActiveTool(null,""):(this.setActiveTool("text","插入文字"),this.brushColor=document.getElementById("brush-color").value)}),document.getElementById("brush-color").addEventListener("change",t=>{this.brushColor=t.target.value}),document.getElementById("brush-size").addEventListener("input",t=>{this.brushSize=parseInt(t.target.value),this.updateBrushCursorSize()}),document.getElementById("add-text-btn").addEventListener("click",()=>this.startTextPlacement()),document.getElementById("text-bold").addEventListener("click",()=>{this.textBold=!this.textBold,document.getElementById("text-bold").classList.toggle("primary",this.textBold)}),document.getElementById("text-italic").addEventListener("click",()=>{this.textItalic=!this.textItalic,document.getElementById("text-italic").classList.toggle("primary",this.textItalic)}),document.getElementById("undo-btn").addEventListener("click",()=>this.undo()),document.getElementById("redo-btn").addEventListener("click",()=>this.redo());var t=document.getElementById("schedule-mode"),t=(t&&t.addEventListener("click",()=>{"schedule"===this.currentTool?this.setActiveTool(null,""):this.setActiveTool("schedule","课表模式：生成课表后点击单元格可编辑")}),document.getElementById("create-schedule-btn")),t=(t&&t.addEventListener("click",()=>this.createSchedule()),document.getElementById("schedule-input-confirm-btn")),e=document.getElementById("schedule-input-cancel-btn"),t=(t&&t.addEventListener("click",()=>this.confirmScheduleInput()),e&&e.addEventListener("click",()=>this.cancelScheduleInput()),document.getElementById("schedule-input"));t&&t.addEventListener("keypress",t=>{"Enter"===t.key&&this.confirmScheduleInput()}),this.canvas.addEventListener("mousedown",this.startPaint),this.canvas.addEventListener("mousemove",this.paint),this.canvas.addEventListener("mouseup",this.endPaint),this.canvas.addEventListener("mouseleave",this.endPaint),this.canvas.addEventListener("click",this.handleCanvasClick),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this.onTouchEnd,{passive:!0}),document.addEventListener("keydown",this.handleKeyboard),this.canvas.addEventListener("mouseenter",this.updateBrushCursor),this.canvas.addEventListener("mousemove",this.updateBrushCursor),this.createBrushCursor(),this.saveToHistory()}handleKeyboard(t){!t.ctrlKey&&!t.metaKey||"z"!==t.key||t.shiftKey?(t.ctrlKey||t.metaKey)&&("y"===t.key||t.shiftKey&&"z"===t.key)&&(t.preventDefault(),this.redo()):(t.preventDefault(),this.undo())}setActiveTool(t,e){setCanvasTitle(e),this.currentTool=t,this.canvas.parentNode.classList.toggle("brush-mode","brush"===this.currentTool),this.canvas.parentNode.classList.toggle("eraser-mode","eraser"===this.currentTool),this.canvas.parentNode.classList.toggle("text-mode","text"===this.currentTool),this.canvas.parentNode.classList.toggle("schedule-mode","schedule"===this.currentTool),document.getElementById("brush-mode").classList.toggle("active","brush"===this.currentTool),document.getElementById("eraser-mode").classList.toggle("active","eraser"===this.currentTool),document.getElementById("text-mode").classList.toggle("active","text"===this.currentTool);var s,i,h,a,e=document.getElementById("schedule-mode");e&&e.classList.toggle("active","schedule"===this.currentTool),"schedule"===this.currentTool&&(t=document.getElementById("card-panel"),e=document.getElementById("card-mode"),s=document.getElementById("wifi-panel"),i=document.getElementById("wifi-mode"),h=document.getElementById("todo-panel"),a=document.getElementById("todo-mode"),t&&(t.style.display="none"),e&&e.classList.remove("active"),s&&(s.style.display="none"),i&&i.classList.remove("active"),h&&(h.style.display="none"),a)&&a.classList.remove("active"),document.getElementById("brush-color").disabled="eraser"===this.currentTool||"schedule"===this.currentTool,document.getElementById("brush-size").disabled="text"===this.currentTool||"schedule"===this.currentTool,document.getElementById("undo-btn").classList.toggle("hide",null===this.currentTool),document.getElementById("redo-btn").classList.toggle("hide",null===this.currentTool),this.cancelTextPlacement()}createBrushCursor(){this.brushCursor=document.createElement("div"),this.brushCursor.id="brush-cursor",this.brushCursor.style.position="fixed",this.brushCursor.style.border="2px solid rgba(0, 0, 0, 0.5)",this.brushCursor.style.borderRadius="50%",this.brushCursor.style.pointerEvents="none",this.brushCursor.style.display="none",this.brushCursor.style.zIndex="10000",this.brushCursor.style.transform="translate(-50%, -50%)",this.brushCursor.style.willChange="transform",this.brushCursor.style.left="0",this.brushCursor.style.top="0",document.body.appendChild(this.brushCursor),this.updateBrushCursorSize(),this.cursorUpdateScheduled=!1,this.pendingCursorX=0,this.pendingCursorY=0}updateBrushCursorSize(){var t,e;this.brushCursor&&(t=(e=this.canvas.getBoundingClientRect()).width/this.canvas.width,e=e.height/this.canvas.height,t=Math.min(t,e),e=this.brushSize*t,this.brushCursor.style.width=e+"px",this.brushCursor.style.height=e+"px")}updateBrushCursor(t){var e;!this.brushCursor||"brush"!==this.currentTool&&"eraser"!==this.currentTool||(e=this.canvas.getBoundingClientRect(),t.clientX>=e.left&&t.clientX<=e.right&&t.clientY>=e.top&&t.clientY<=e.bottom?(this.brushCursor.style.display="block",this.canvas.style.cursor="none",this.pendingCursorX=t.clientX,this.pendingCursorY=t.clientY,this.cursorUpdateScheduled||(this.cursorUpdateScheduled=!0,requestAnimationFrame(()=>{this.brushCursor.style.transform=`translate(${this.pendingCursorX}px, ${this.pendingCursorY}px) translate(-50%, -50%)`,this.cursorUpdateScheduled=!1})),"eraser"===this.currentTool?"eraser"!==this.brushCursor.getAttribute("data-tool")&&(this.brushCursor.style.border="2px solid rgba(255, 0, 0, 0.7)",this.brushCursor.style.backgroundColor="rgba(255, 255, 255, 0.2)",this.brushCursor.style.boxShadow="none",this.brushCursor.setAttribute("data-tool","eraser")):"brush"!==this.brushCursor.getAttribute("data-tool")&&(this.brushCursor.style.border="1px solid white",this.brushCursor.style.boxShadow="0 0 0 1px black, inset 0 0 0 1px black",this.brushCursor.style.backgroundColor="transparent",this.brushCursor.setAttribute("data-tool","brush"))):this.brushCursor.style.display="none")}hideBrushCursor(){this.brushCursor&&(this.brushCursor.style.display="none"),this.canvas.style.cursor="default"}startPaint(t){var e,s,i,h;this.currentTool&&"schedule"!==this.currentTool&&("text"===this.currentTool?(e=this.findTextElementAt(t))&&e===this.selectedTextElement&&(this.isDraggingText=!0,h=this.canvas.getBoundingClientRect(),i=this.canvas.width/h.width,s=this.canvas.height/h.height,i=(t.clientX-h.left)*i,h=(t.clientY-h.top)*s,this.dragOffsetX=e.x-i,this.dragOffsetY=e.y-h):(this.painting=!0,this.draw(t)))}endPaint(){(this.painting||this.isDraggingText)&&this.saveToHistory(),this.painting=!1,this.isDraggingText=!1,this.lastX=0,this.lastY=0,this.hideBrushCursor()}paint(t){this.currentTool&&"schedule"!==this.currentTool&&("text"===this.currentTool?this.isDraggingText&&this.selectedTextElement&&this.dragText(t):this.painting&&this.draw(t))}draw(t){var e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,s=(t.clientX-e.left)*s,t=(t.clientY-e.top)*i;this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.strokeStyle=this.brushColor,this.ctx.lineWidth=this.brushSize,this.ctx.beginPath(),0===this.lastX&&0===this.lastY?(this.ctx.moveTo(s,t),this.ctx.lineTo(.1+s,.1+t),this.lineSegments.push({type:"dot",x:s,y:t,color:this.brushColor,size:this.brushSize})):(this.ctx.moveTo(this.lastX,this.lastY),this.ctx.lineTo(s,t),this.lineSegments.push({type:"line",x1:this.lastX,y1:this.lastY,x2:s,y2:t,color:this.brushColor,size:this.brushSize})),this.ctx.stroke(),this.lastX=s,this.lastY=t}handleCanvasClick(t){var e,s,i;"text"===this.currentTool&&this.isTextPlacementMode?this.placeText(t):"schedule"===this.currentTool&&this.scheduleData&&(e=this.canvas.getBoundingClientRect(),i=this.canvas.width/e.width,s=this.canvas.height/e.height,i=(t.clientX-e.left)*i,i=this.getScheduleCellAt(i,(t.clientY-e.top)*s))&&(this.selectedScheduleCell=i,t=this.scheduleData[i.row][i.col],document.getElementById("schedule-input").value=t,document.getElementById("schedule-input").focus())}onTouchStart(e){e=e.touches[0];if("text"===this.currentTool&&this.isTextPlacementMode){let t=new MouseEvent("click",{clientX:e.clientX,clientY:e.clientY});void this.canvas.dispatchEvent(t)}else{let t=new MouseEvent("mousedown",{clientX:e.clientX,clientY:e.clientY});this.canvas.dispatchEvent(t)}}onTouchMove(t){t=t.touches[0],t=new MouseEvent("mousemove",{clientX:t.clientX,clientY:t.clientY});this.canvas.dispatchEvent(t)}onTouchEnd(t){this.endPaint()}dragText(t){var e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,s=(t.clientX-e.left)*s,t=(t.clientY-e.top)*i;this.selectedTextElement.x=s+this.dragOffsetX,this.selectedTextElement.y=t+this.dragOffsetY,this.draggingCanvasContext?this.ctx.putImageData(this.draggingCanvasContext,0,0):this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.font=this.selectedTextElement.font,this.ctx.fillStyle=this.selectedTextElement.color,this.ctx.fillText(this.selectedTextElement.text,this.selectedTextElement.x,this.selectedTextElement.y)}findTextElementAt(t){var e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,h=(t.clientX-e.left)*s,a=(t.clientY-e.top)*i;for(let t=this.textElements.length-1;0<=t;t--){var n=this.textElements[t],o=(this.ctx.font=n.font,this.ctx.measureText(n.text).width),l=n.font.match(/(\d+)px/),l=l?parseInt(l[1]):14;if(h>=n.x-5&&h<=n.x+o+5&&a>=n.y-1.2*l+5&&a<=n.y+5)return n}return null}startTextPlacement(){document.getElementById("text-input").value.trim()?(this.isTextPlacementMode=!0,setCanvasTitle("点击画布放置文字"),this.canvas.classList.add("text-placement-mode")):alert("请输入文字内容")}cancelTextPlacement(){this.isTextPlacementMode=!1,this.canvas.classList.remove("text-placement-mode"),this.isDraggingText=!1,this.dragOffsetX=0,this.dragOffsetY=0,this.selectedTextElement=null,this.draggingCanvasContext=null}placeText(t){var e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,s=(t.clientX-e.left)*s,t=(t.clientY-e.top)*i,e=document.getElementById("text-input").value,i=document.getElementById("font-family").value,h=document.getElementById("font-size").value;let a="";this.textItalic&&(a+="italic "),this.textBold&&(a+="bold ");e={text:e,x:s,y:t,font:""+a+h+"px "+i,color:this.brushColor};this.textElements.push(e),this.selectedTextElement=e,this.draggingCanvasContext=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),this.ctx.font=e.font,this.ctx.fillStyle=e.color,this.ctx.fillText(e.text,e.x,e.y),this.saveToHistory(),document.getElementById("text-input").value="",this.isTextPlacementMode=!1,this.canvas.classList.remove("text-placement-mode"),setCanvasTitle("拖动新添加文字可调整位置")}redrawTextElements(){this.textElements.forEach(t=>{this.ctx.font=t.font,this.ctx.fillStyle=t.color,this.ctx.fillText(t.text,t.x,t.y)})}redrawLineSegments(){this.lineSegments.forEach(t=>{this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.strokeStyle=t.color,this.ctx.lineWidth=t.size,this.ctx.beginPath(),"dot"===t.type?(this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(t.x+.1,t.y+.1)):(this.ctx.moveTo(t.x1,t.y1),this.ctx.lineTo(t.x2,t.y2)),this.ctx.stroke()})}redrawAll(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.redrawLineSegments(),this.textElements.forEach(t=>{this.ctx.font=t.font,this.ctx.fillStyle=t.color,this.ctx.fillText(t.text,t.x,t.y)}),this.scheduleData&&0<this.scheduleData.length?this.drawSchedule():this.todoData&&0<this.todoData.length?this.drawTodoList():this.wifiData?this.drawWifiConnect():this.cardData&&this.drawBusinessCard()}clearElements(){this.textElements=[],this.lineSegments=[],this.scheduleData=null,this.todoData=null,this.cardData=null,this.wifiData=null}async createBusinessCard(){await this.loadPCFFonts(),this.lineSegments=[],this.textElements=[],this.scheduleData=null,this.todoData=null,this.wifiData=null;var t=t=>(document.getElementById(t)?.value||"").trim(),t={name:t("card-name"),title:t("card-title"),phone:t("card-phone"),email:t("card-email"),website:t("card-website"),footer:t("card-footer")},e=Object.values(t).some(t=>0<(t||"").trim().length);this.cardData=e?t:null,this.redrawAll(),this.saveToHistory()}drawBusinessCard(){let t=this.cardData;if(t){var i=this.canvas.width-40,h=this.canvas.height-40;this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.strokeRect(20,20,i,h);let n=this.pcfFontsLoaded&&pcfFontManager.isLoaded(this.weekdayFontName)&&pcfFontManager.isLoaded(this.courseFontName);var a=this.weekdayFontName,l=this.courseFontName;let c=t=>((t||"")+"").trim(),o=t=>{this.ctx.font="name"===t?"20px SimHei, sans-serif":"title"===t?"14px SimHei, sans-serif":"12px SimHei, sans-serif"},d=(t,e,s)=>n&&pcfFontManager.isLoaded(t)?pcfFontManager.measureText(t,e):(o(s),this.ctx.measureText(e).width);var m=(t,e)=>n&&pcfFontManager.isLoaded(t)?(t=((t=pcfFontManager.getFontMetrics(t)).fontAscent||0)+(t.fontDescent||0),Math.max(14,t+4)):"name"===e?26:"title"===e?18:16,x=(t,e,s,i,h)=>{var a;e&&(n&&pcfFontManager.isLoaded(t)?(a=i+(pcfFontManager.getFontMetrics(t).fontAscent||0),pcfFontManager.renderText(this.ctx,t,e,s,a,"#000000")):(this.ctx.fillStyle="#000000",o(h),this.ctx.fillText(e,s,i+("name"===h?20:"title"===h?14:12))))};let u=(t,e,s,i)=>{e=c(e);if(!e)return"";if(d(t,e,i)<=s)return e;var h="...";if(d(t,h,i)>s)return"";let a=e;for(;0<a.length&&d(t,a+h,i)>s;)a=a.slice(0,-1);return a.length?a+h:h};let e=Math.floor(Math.max(110,Math.min(190,.34*i,.46*h))),r=20+i-12-e,g=32;var f,y,p=t=>{if("function"!=typeof qrcode)return!1;var s=qrcode(0,"M"),i=(s.addData(t),s.make(),s.getModuleCount()),t=i+8,h=Math.floor(e/t);if(h<=0)return!1;var a,n,t=h*t,o=r+Math.floor((e-t)/2),l=g+Math.floor((e-t)/2);this.ctx.fillStyle="#ffffff",this.ctx.fillRect(r,g,e,e),this.ctx.fillStyle="#000000";for(let e=0;e<i;e++)for(let t=0;t<i;t++)s.isDark(e,t)&&(a=o+(t+4)*h,n=l+(e+4)*h,this.ctx.fillRect(a,n,h,h));return!0};try{v=c(t.name),T=c(t.title),C=c(t.phone),w=c(t.email),D=c(t.website),(y=[]).push("BEGIN:VCARD"),y.push("VERSION:3.0"),v&&(y.push(`N:;${v};;;`),y.push("FN:"+v)),T&&y.push("TITLE:"+T),C&&y.push("TEL;TYPE=CELL:"+C),w&&y.push("EMAIL:"+w),D&&y.push("URL:"+D),y.push("END:VCARD"),p(y.join("\n"))||(f=d(l,"QR","body"),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(r,g,e,e),x(l,"QR",r+(e-f)/2,g+(e-m(l,"body"))/2,"body"))}catch(t){this.ctx.fillStyle="#ffffff",this.ctx.fillRect(r,g,e,e);var v=d(l,"QR","body");x(l,"QR",r+(e-v)/2,g+(e-m(l,"body"))/2,"body")}var S=Math.max(10,r-12-32);let s=32;var T=u(a,c(t.name),S,"name"),C=(T&&(x(a,T,32,s,"name"),s+=m(a,"name")),u(l,c(t.title),S,"title")),b=(C&&(x(l,C,32,s,"title"),s+=m(l,"title")),s+=4,this.ctx.beginPath(),this.ctx.moveTo(32,s),this.ctx.lineTo(32+S,s),this.ctx.stroke(),s+=10,[]),F=(c(t.phone)&&b.push("电话: "+c(t.phone)),c(t.email)&&b.push("邮箱: "+c(t.email)),c(t.website)&&b.push("网站: "+c(t.website)),20+h-40);for(let t=0;t<b.length&&!(s>F);t++){var E=((e,t,s,i,h)=>{var a=c(t);if(!a)return[];var n=[];let o="";for(let t=0;t<a.length;t++){var l=a[t],r=o+l;if(d(e,r,h)<=s||0===o.length)o=r;else if(n.push(o),o=l,i-1<=n.length)return r=a.slice(t),n.push(u(e,o+r,s,h)),n}return o&&n.push(o),n.slice(0,i)})(l,b[t],S,2,"body");for(let t=0;t<E.length&&!(s>F);t++)x(l,E[t],32,s,"body"),s+=m(l,"body");s+=2}var D,w=c(t.footer);w&&(D=20+h-12-m(l,"body")+4,x(l,p=u(l,w,i-24,"body"),20+(i-d(l,p,"body"))/2,D,"body"))}}async createWifiConnect(){await this.loadPCFFonts(),this.lineSegments=[],this.textElements=[],this.scheduleData=null,this.todoData=null,this.cardData=null;var t=t=>(document.getElementById(t)?.value||"").trim(),e=t("wifi-ssid"),t=t("wifi-password"),s=(document.getElementById("wifi-encryption")?.value||"WPA").trim(),i=!!document.getElementById("wifi-hidden")?.checked;this.wifiData=e?{ssid:e,password:t,encryption:s,hidden:i}:null,this.redrawAll(),this.saveToHistory()}drawWifiConnect(){let l=this.wifiData;if(l){var s=this.canvas.width-40,i=this.canvas.height-40;let n=this.pcfFontsLoaded&&pcfFontManager.isLoaded(this.weekdayFontName)&&pcfFontManager.isLoaded(this.courseFontName);var r=this.weekdayFontName;this.courseFontName;let h=t=>((t||"")+"").trim(),o=t=>{this.ctx.font="title"===t?"20px SimHei, sans-serif":"12px SimHei, sans-serif"},t=(t,e,s)=>n&&pcfFontManager.isLoaded(t)?pcfFontManager.measureText(t,e):(o(s),this.ctx.measureText(e).width);var c=(t,e,s,i,h)=>{var a;e&&(n&&pcfFontManager.isLoaded(t)?(a=i+(pcfFontManager.getFontMetrics(t).fontAscent||0),pcfFontManager.renderText(this.ctx,t,e,s,a,"#000000")):(this.ctx.fillStyle="#000000",o(h),this.ctx.fillText(e,s,i+("title"===h?20:12))))};let a=t=>(t||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/:/g,"\\:");let d=(t,e,s)=>{var s=Math.max(12,s),i=.45*s,h=.3*s,a=.16*s,n=Math.max(1.2,.06*s),o=(this.ctx.save(),this.ctx.strokeStyle="#FF0000",this.ctx.fillStyle="#FF0000",this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(1.5,.08*s),1.15*Math.PI),l=1.85*Math.PI;this.ctx.beginPath(),this.ctx.arc(t,e+.02*s,i,o,l),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(t,e+.06*s,h,o,l),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(t,e+.1*s,a,o,l),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(t,e+.18*s,2*n,0,2*Math.PI),this.ctx.fill(),this.ctx.restore()};x=r,f="title";var x=n&&pcfFontManager.isLoaded(x)?(x=((x=pcfFontManager.getFontMetrics(x)).fontAscent||0)+(x.fontDescent||0),Math.max(14,x+4)):"title"===f?26:16,f=Math.max(60,i-24-(3*x+24));let u=Math.floor(1.4*Math.max(140,Math.floor(Math.min(.6*s,f)))),g=20+(s-u)/2,m=32+(f-u)/2;i=t=>{if("function"!=typeof qrcode)return!1;var s=qrcode(0,"H"),i=(s.addData(t),s.make(),s.getModuleCount()),t=i+8,h=Math.floor(u/t);if(h<=0)return!1;var a,n,t=h*t,o=g+Math.floor((u-t)/2),l=m+Math.floor((u-t)/2);this.ctx.fillStyle="#ffffff",this.ctx.fillRect(g,m,u,u),this.ctx.fillStyle="#000000";for(let e=0;e<i;e++)for(let t=0;t<i;t++)s.isDark(e,t)&&(a=o+(t+4)*h,n=l+(e+4)*h,this.ctx.fillRect(a,n,h,h));var t=g+u/2,e=m+u/2,r=Math.max(20,Math.floor(.15*u)),c=Math.floor(.8*r);return this.ctx.save(),this.ctx.fillStyle="rgba(255,255,255,0.96)",this.ctx.beginPath(),this.ctx.arc(t,e,c,0,2*Math.PI),this.ctx.fill(),this.ctx.restore(),d(t,e,r),!0};let e=!1;try{e=i((()=>{var t=a(h(l.ssid)),e=h(l.encryption)||"WPA",s=!!l.hidden;let i=`WIFI:T:${e};S:${t};`;return"nopass"!==e&&(t=a(h(l.password)))&&(i+=`P:${t};`),s&&(i+="H:true;"),i+=";"})())}catch(t){e=!1}e||(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(g,m,u,u),s=t(r,"QR","title"),c(r,"QR",g+(u-s)/2,m+(u-x)/2,"title"));var f=g+u/2,i=(Math.max(t(r,"网络:","title"),t(r,"密码:","title")),h(l.ssid)),s=h(l.password)||" ",y=m+u+x,i=(c(r,"扫码连接",f-t(r,"扫码连接","title")/2,y,"title"),"网络: "+i),i=(c(r,i,f-t(r,i,"title")/2,y+x,"title"),"密码: "+s);c(r,i,f-t(r,i,"title")/2,y+2*x,"title")}}async createSchedule(){await this.loadPCFFonts(),this.scheduleDays=parseInt(document.getElementById("schedule-days").value),this.scheduleClasses=parseInt(document.getElementById("schedule-classes").value),this.scheduleFontSize=parseInt(document.getElementById("schedule-font-size").value),this.lineSegments=[],this.textElements=[],this.todoData=null,this.cardData=null,this.wifiData=null,this.calculateScheduleDimensions(),this.scheduleData=[];for(let e=0;e<=this.scheduleClasses;e++){this.scheduleData[e]=[];for(let t=0;t<=this.scheduleDays;t++)0===e&&0===t?this.scheduleData[e][t]="":0===e?this.scheduleData[e][t]=this.weekDays[t-1]:0===t?this.scheduleData[e][t]=`第${e}节`:this.scheduleData[e][t]=""}this.redrawAll(),this.saveToHistory()}calculateScheduleDimensions(){this.scheduleTitleText="课程表",this.scheduleTitleFontSize=12,this.scheduleTitleAreaHeight=24;var t=this.canvas.width-40,e=this.canvas.height-40-this.scheduleTitleAreaHeight,t=Math.floor(t/(this.scheduleDays+1)),e=Math.floor(e/(this.scheduleClasses+1));this.scheduleCellWidth=Math.max(t,4*this.scheduleFontSize),this.scheduleCellHeight=Math.max(e,2*this.scheduleFontSize),this.scheduleStartX=20,this.scheduleStartY=20+this.scheduleTitleAreaHeight}async createTodoList(){await this.loadPCFFonts(),this.todoCount=parseInt(document.getElementById("todo-count").value),this.todoFontSize=parseInt(document.getElementById("todo-font-size").value),this.lineSegments=[],this.textElements=[],this.scheduleData=null,this.cardData=null,this.wifiData=null,this.wifiData=null,this.calculateTodoDimensions(),this.todoData=[];for(let t=0;t<this.todoCount;t++)this.todoData.push({text:"",done:!1});this.redrawAll(),this.saveToHistory()}calculateTodoDimensions(){this.todoTitleText=this.todoTitleText||"待办事项",this.todoTitleAreaHeight=24;var t=this.canvas.width-40,e=this.canvas.height-40-this.todoTitleAreaHeight,e=Math.floor(e/Math.max(1,this.todoCount||1));this.todoRowHeight=Math.max(e,2*this.todoFontSize),this.todoStartX=20,this.todoStartY=20+this.todoTitleAreaHeight,this.todoWidth=t}drawTodoList(){if(this.todoData&&0!==this.todoData.length){var s=this.todoStartX,i=this.todoStartY,h=this.todoRowHeight,a=this.todoWidth||this.canvas.width-40,n=(this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.pcfFontsLoaded&&pcfFontManager.isLoaded(this.weekdayFontName)&&pcfFontManager.isLoaded(this.courseFontName));let t=this.todoColor||"#000000";var e,o,l=this.todoTitleText||"待办事项",r=this.todoTitleAreaHeight||18,c=i-r-14,d=this.weekdayFontName,u=(n&&pcfFontManager.isLoaded(d)?(u=pcfFontManager.measureText(d,l),o=((e=pcfFontManager.getFontMetrics(d)).fontAscent||0)+(e.fontDescent||0),pcfFontManager.renderText(this.ctx,d,l,s+(a-u)/2,c+(r-o)/2+(e.fontAscent||0),t)):(this.ctx.fillStyle=t,this.ctx.font="12px SimHei, sans-serif",d=this.ctx.measureText(l).width,this.ctx.fillText(l,s+(a-d)/2,c+r/2+4)),h*this.todoData.length),g=(this.ctx.strokeRect(s,i,a,u),Math.min(16,Math.max(12,h-10))),m=s+8+g+10,x=this.courseFontName;for(let e=0;e<this.todoData.length;e++){var f,y=i+e*h,p=(0<e&&(this.ctx.beginPath(),this.ctx.moveTo(s,y),this.ctx.lineTo(s+a,y),this.ctx.stroke()),s+8),v=y+(h-g)/2,p=(this.ctx.strokeRect(p,v,g,g),this.todoData[e].done&&(this.ctx.beginPath(),this.ctx.moveTo(p+3,v+.55*g),this.ctx.lineTo(p+.42*g,v+g-3),this.ctx.lineTo(p+g-3,v+3),this.ctx.stroke()),this.todoData[e]),v=(p.text||"").trim();let t=p.color||"#000000";v&&(n&&pcfFontManager.isLoaded(x)?(f=((p=pcfFontManager.getFontMetrics(x)).fontAscent||0)+(p.fontDescent||0),pcfFontManager.renderText(this.ctx,x,v,m,y+(h-f)/2+(p.fontAscent||0),t)):(this.ctx.fillStyle=t,this.ctx.font=this.todoFontSize+"px SimHei, sans-serif",f=y+h/2+this.todoFontSize/3,this.ctx.fillText(v,m,f)))}}}drawSchedule(){if(this.scheduleData){var i=this.scheduleCellWidth,h=this.scheduleCellHeight,a=this.scheduleStartX,n=this.scheduleStartY;this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1;let t=this.scheduleColor||"#000000";var e,s,o,l=this.pcfFontsLoaded&&pcfFontManager.isLoaded(this.weekdayFontName)&&pcfFontManager.isLoaded(this.courseFontName),r=(console.log("绘制课表 - PCF字体状态:",{pcfFontsLoaded:this.pcfFontsLoaded,weekdayFontLoaded:pcfFontManager.isLoaded(this.weekdayFontName),courseFontLoaded:pcfFontManager.isLoaded(this.courseFontName),usePCFFont:l}),l?console.log("使用PCF字体渲染课表"):(console.log("使用Canvas字体渲染课表（PCF字体未加载）"),r=this.scheduleFontSize+"px SimHei, sans-serif",this.ctx.font=r,this.ctx.fillStyle=t),this.scheduleTitleText||"课程表"),c=this.scheduleTitleAreaHeight||18,d=this.weekdayFontName,u=i*this.scheduleData[0].length,g=a,m=n-c-14;r&&(l&&pcfFontManager.isLoaded(d)?(e=pcfFontManager.measureText(d,r),s=((o=pcfFontManager.getFontMetrics(d)).fontAscent||0)+(o.fontDescent||0),pcfFontManager.renderText(this.ctx,d,r,g+(u-e)/2,m+(c-s)/2+(o.fontAscent||0),t)):(this.ctx.fillStyle=t,this.ctx.font="12px SimHei, sans-serif",d=this.ctx.measureText(r).width,this.ctx.fillText(r,g+(u-d)/2,m+c/2+4)));for(let s=0;s<this.scheduleData.length;s++)for(let e=0;e<this.scheduleData[s].length;e++){var x,f,y=a+e*i,p=n+s*h,v=(this.ctx.strokeRect(y,p,i,h),this.scheduleData[s][e]),S="string"==typeof v?v:v?.text||"";let t="object"==typeof v&&v.color||"#000000";S&&(l?(v=0===s||0===e?this.weekdayFontName:this.courseFontName,f=pcfFontManager.measureText(v,S),x=p+h/2+pcfFontManager.getFontMetrics(v).fontAscent/2,pcfFontManager.renderText(this.ctx,v,S,y+(i-f)/2,x,t)):(v=y+i/2-this.ctx.measureText(S).width/2,f=p+h/2+this.scheduleFontSize/3,this.ctx.fillStyle=t,this.ctx.fillText(S,v,f)))}this.selectedScheduleCell&&(e=this.selectedScheduleCell.row,s=a+this.selectedScheduleCell.col*i,o=n+e*h,this.ctx.fillStyle="#FF0000",this.ctx.beginPath(),this.ctx.arc(s+i-5,o+5,3,0,2*Math.PI),this.ctx.fill())}}getScheduleCellAt(t,e){var s,i,h,a;return this.scheduleData&&(s=this.scheduleCellWidth,i=this.scheduleCellHeight,a=this.scheduleStartX,h=this.scheduleStartY,t=Math.floor((t-a)/s),0<=(a=Math.floor((e-h)/i)))&&a<this.scheduleData.length&&0<=t&&t<this.scheduleData[0].length?{row:a,col:t}:null}updateScheduleCell(t,e,s){this.scheduleData&&0<=t&&0<=e&&t<this.scheduleData.length&&e<this.scheduleData[0].length&&(this.scheduleData[t][e]=s,this.redrawAll(),this.saveToHistory())}confirmScheduleInput(){var t;this.selectedScheduleCell&&(t=document.getElementById("schedule-input").value,this.updateScheduleCell(this.selectedScheduleCell.row,this.selectedScheduleCell.col,t),this.cancelScheduleInput())}cancelScheduleInput(){this.selectedScheduleCell=null,document.getElementById("schedule-input").value="",this.scheduleData&&this.redrawAll()}}