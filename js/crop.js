class CropManager{constructor(t,n){this.canvas=t,this.ctx=n,this.backgroundZoom=1,this.backgroundPanX=0,this.backgroundPanY=0,this.isPanning=!1,this.lastPanX=0,this.lastPanY=0,this.lastTouchDistance=0,this.handleBackgroundZoom=this.handleBackgroundZoom.bind(this),this.handleBackgroundPanStart=this.handleBackgroundPanStart.bind(this),this.handleBackgroundPan=this.handleBackgroundPan.bind(this),this.handleBackgroundPanEnd=this.handleBackgroundPanEnd.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this)}resetStates(){this.backgroundZoom=1,this.backgroundPanX=0,this.backgroundPanY=0,this.isPanning=!1,this.lastPanX=0,this.lastPanY=0,this.lastTouchDistance=0}isCropMode(){return this.canvas.parentNode.classList.contains("crop-mode")}exitCropMode(){this.canvas.parentNode.classList.remove("crop-mode"),setCanvasTitle(""),this.canvas.removeEventListener("wheel",this.handleBackgroundZoom,{passive:!0}),this.canvas.removeEventListener("mousedown",this.handleBackgroundPanStart),this.canvas.removeEventListener("mousemove",this.handleBackgroundPan),this.canvas.removeEventListener("mouseup",this.handleBackgroundPanEnd),this.canvas.removeEventListener("mouseleave",this.handleBackgroundPanEnd),this.canvas.removeEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.canvas.removeEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.canvas.removeEventListener("touchend",this.handleBackgroundPanEnd,{passive:!0}),this.canvas.removeEventListener("touchcancel",this.handleBackgroundPanEnd,{passive:!0})}initializeCrop(){var t=document.getElementById("imageFile");0==t.files.length?fillCanvas("white"):(this.exitCropMode(),this.resetStates(),this.canvas.style.backgroundImage=`url(${URL.createObjectURL(t.files[0])})`,this.canvas.style.backgroundSize="100%",this.canvas.style.backgroundPosition="",this.canvas.style.backgroundRepeat="no-repeat",this.canvas.addEventListener("wheel",this.handleBackgroundZoom,{passive:!0}),this.canvas.addEventListener("mousedown",this.handleBackgroundPanStart),this.canvas.addEventListener("mousemove",this.handleBackgroundPan),this.canvas.addEventListener("mouseup",this.handleBackgroundPanEnd),this.canvas.addEventListener("mouseleave",this.handleBackgroundPanEnd),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this.handleBackgroundPanEnd,{passive:!0}),this.canvas.addEventListener("touchcancel",this.handleBackgroundPanEnd,{passive:!0}),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),setCanvasTitle("裁剪模式: 可用鼠标滚轮或双指触摸缩放图片"),this.canvas.parentNode.classList.add("crop-mode"))}finishCrop(o){var t=document.getElementById("imageFile");if(0!=t.files.length){let i=new Image;i.onload=()=>{URL.revokeObjectURL(i.src);var t=this.canvas.getBoundingClientRect(),n=i.width/t.width/this.backgroundZoom,e=-this.backgroundPanX*n,a=-this.backgroundPanY*n,s=t.width*n,t=t.height*n;fillCanvas("white"),this.ctx.drawImage(i,e,a,s,t,0,0,this.canvas.width,this.canvas.height),this.exitCropMode(),o&&setTimeout(o,0)},i.src=URL.createObjectURL(t.files[0])}}handleTouchStart(t){1===t.touches.length?this.handleBackgroundPanStart(t.touches[0]):2===t.touches.length&&(this.isPanning=!1,this.lastTouchDistance=this.getTouchDistance(t.touches))}handleTouchMove(t){var n;this.isPanning&&1===t.touches.length?this.handleBackgroundPan(t.touches[0]):2===t.touches.length&&(t=this.getTouchDistance(t.touches),0<this.lastTouchDistance&&(n=t/this.lastTouchDistance,this.backgroundZoom*=n,this.backgroundZoom=Math.max(.1,Math.min(5,this.backgroundZoom)),this.updateBackgroundTransform()),this.lastTouchDistance=t)}handleBackgroundZoom(t){t=0<t.deltaY?.9:1.1;this.backgroundZoom*=t,this.backgroundZoom=Math.max(.1,Math.min(5,this.backgroundZoom)),this.updateBackgroundTransform()}handleBackgroundPanStart(t){this.isPanning=!0,this.lastPanX=t.clientX,this.lastPanY=t.clientY,this.canvas.style.cursor="grabbing"}handleBackgroundPan(t){var n,e;this.isPanning&&(n=t.clientX-this.lastPanX,e=t.clientY-this.lastPanY,this.backgroundPanX+=n,this.backgroundPanY+=e,this.lastPanX=t.clientX,this.lastPanY=t.clientY,this.updateBackgroundTransform())}handleBackgroundPanEnd(){this.isPanning=!1,this.lastTouchDistance=0,this.canvas.style.cursor="grab"}updateBackgroundTransform(){this.canvas.style.backgroundSize=100*this.backgroundZoom+"%",this.canvas.style.backgroundPosition=`${this.backgroundPanX}px ${this.backgroundPanY}px`}getTouchDistance(t){var n=t[0],t=t[1];return Math.sqrt(Math.pow(t.clientX-n.clientX,2)+Math.pow(t.clientY-n.clientY,2))}initCropTools(){document.getElementById("crop-zoom-in").addEventListener("click",t=>{t.preventDefault(),this.handleBackgroundZoom({preventDefault:()=>{},deltaY:-1})}),document.getElementById("crop-zoom-out").addEventListener("click",t=>{t.preventDefault(),this.handleBackgroundZoom({preventDefault:()=>{},deltaY:1})}),document.getElementById("crop-move-left").addEventListener("click",t=>{t.preventDefault(),this.backgroundPanX-=10,this.updateBackgroundTransform()}),document.getElementById("crop-move-right").addEventListener("click",t=>{t.preventDefault(),this.backgroundPanX+=10,this.updateBackgroundTransform()}),document.getElementById("crop-move-up").addEventListener("click",t=>{t.preventDefault(),this.backgroundPanY-=10,this.updateBackgroundTransform()}),document.getElementById("crop-move-down").addEventListener("click",t=>{t.preventDefault(),this.backgroundPanY+=10,this.updateBackgroundTransform()});var t=document.getElementById("crop-done-btn"),t=(t&&t.addEventListener("click",t=>{t.preventDefault(),this.finishCrop(()=>{"function"==typeof convertDithering?convertDithering():"function"==typeof applyDither&&applyDither()})}),document.getElementById("crop-cancel-btn"));t&&t.addEventListener("click",t=>{t.preventDefault(),this.exitCropMode()})}}