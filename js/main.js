let bleDevice,gattServer,epdService,epdCharacteristic,startTime,msgIndex,appVersion,canvas,ctx,textDecoder,paintManager,cropManager,EpdCmd={SET_PINS:0,INIT:1,CLEAR:2,SEND_CMD:3,SEND_DATA:4,REFRESH:5,SLEEP:6,SET_TIME:32,WRITE_IMG:48,SET_CONFIG:144,SYS_RESET:145,SYS_SLEEP:146,CFG_ERASE:153,SET_HOLIDAYS:182},canvasSizes=[{name:"1.54_152_152",width:152,height:152},{name:"1.54_200_200",width:200,height:200},{name:"2.13_212_104",width:212,height:104},{name:"2.13_250_122",width:250,height:122},{name:"2.66_296_152",width:296,height:152},{name:"2.9_296_128",width:296,height:128},{name:"2.9_384_168",width:384,height:168},{name:"3.5_384_184",width:384,height:184},{name:"3.7_416_240",width:416,height:240},{name:"3.97_800_480",width:800,height:480},{name:"4.2_400_300",width:400,height:300},{name:"5.79_792_272",width:792,height:272},{name:"5.83_600_448",width:600,height:448},{name:"5.83_648_480",width:648,height:480},{name:"7.5_640_384",width:640,height:384},{name:"7.5_800_480",width:800,height:480},{name:"7.5_880_528",width:880,height:528},{name:"10.2_960_640",width:960,height:640},{name:"10.85_1360_480",width:1360,height:480},{name:"11.6_960_640",width:960,height:640},{name:"4E_600_400",width:600,height:400},{name:"7.3E6",width:480,height:800}];function hex2bytes(e){for(var t=[],a=0;a<e.length;a+=2)t.push(parseInt(e.substr(a,2),16));return new Uint8Array(t)}function bytes2hex(e){return new Uint8Array(e).reduce(function(e,t){return e+("0"+t.toString(16)).slice(-2)},"")}function intToHex(e){e=("0000"+e.toString(16)).substr(-4);return e.substring(2,4)+e.substring(0,2)}function resetVariables(){gattServer=null,epdService=null,epdCharacteristic=null,msgIndex=0,document.getElementById("log").value=""}async function filterConnect(){await preConnect(!0)}async function write(e,t,a=!0){if(!epdCharacteristic)return addLog("æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è“ç‰™è¿æ¥"),!1;e=[e];t&&((t="string"==typeof t?hex2bytes(t):t)instanceof Uint8Array&&(t=Array.from(t)),e.push(...t)),addLog(bytes2hex(e),"â‡‘");try{a?await epdCharacteristic.writeValueWithResponse(Uint8Array.from(e)):await epdCharacteristic.writeValueWithoutResponse(Uint8Array.from(e))}catch(e){return console.error(e),e.message&&addLog("write: "+e.message),!1}return!0}async function writeImage(t,a="bw"){var n=document.getElementById("mtusize").value-2,i=document.getElementById("interleavedcount").value,d=Math.round(t.length/n);let o=0,r=i;for(let e=0;e<t.length;e+=n){var l=((new Date).getTime()-startTime)/1e3,l=(setStatus(`${"bw"==a?"é»‘ç™½":"é¢œè‰²"}å—: ${o+1}/${d+1}, æ€»ç”¨æ—¶: ${l}s`),[("bw"==a?15:0)|(0==e?0:240),...t.slice(e,e+n)]);0<r?(await write(EpdCmd.WRITE_IMG,l,!1),r--):(await write(EpdCmd.WRITE_IMG,l,!0),r=i),o++}}async function setDriver(){await write(EpdCmd.SET_PINS,document.getElementById("epdpins").value),await write(EpdCmd.INIT,document.getElementById("epddriver").value)}async function syncTime(e){var t;(2!==e||confirm("æé†’ï¼šæ—¶é’Ÿæ¨¡å¼ç›®å‰ä½¿ç”¨å…¨åˆ·å®ç°ï¼Œæ­¤åŠŸèƒ½ç›®å‰å¤šç”¨äºä¿®å¤è€åŒ–å±æ®‹å½±é—®é¢˜ï¼Œä¸å»ºè®®é•¿æœŸå¼€å¯ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ"))&&(t=(new Date).getTime()/1e3,t=new Uint8Array([t>>24&255,t>>16&255,t>>8&255,255&t,-(new Date).getTimezoneOffset()/60,e]),await write(EpdCmd.SET_TIME,t))&&(addLog("æ—¶é—´å·²åŒæ­¥ï¼"),addLog("å±å¹•åˆ·æ–°å®Œæˆå‰è¯·ä¸è¦æ“ä½œã€‚"))}async function clearScreen(){confirm("ç¡®è®¤æ¸…é™¤å±å¹•å†…å®¹?")&&(await write(EpdCmd.CLEAR),addLog("æ¸…å±æŒ‡ä»¤å·²å‘é€ï¼"),addLog("å±å¹•åˆ·æ–°å®Œæˆå‰è¯·ä¸è¦æ“ä½œã€‚"))}function setCurrentTimestamp(){var e=Math.floor((new Date).getTime()/1e3);document.getElementById("testTimestamp").value=e,updateTimestampInfo()}function addDays(e){var t=document.getElementById("testTimestamp"),a=parseInt(t.value)||Math.floor((new Date).getTime()/1e3);t.value=a+=86400*e,updateTimestampInfo()}function updateTimestampInfo(){var e,t,a,n,i,d,o=document.getElementById("testTimestamp"),r=document.getElementById("timestampInfo"),o=parseInt(o.value);isNaN(o)||o<=0?r.textContent="":(e=(o=new Date(1e3*o)).getFullYear(),t=String(o.getMonth()+1).padStart(2,"0"),a=String(o.getDate()).padStart(2,"0"),n=String(o.getHours()).padStart(2,"0"),i=String(o.getMinutes()).padStart(2,"0"),d=String(o.getSeconds()).padStart(2,"0"),o=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][o.getDay()],r.textContent=`å¯¹åº”æ—¶é—´: ${e}-${t}-${a} æ˜ŸæœŸ${o} ${n}:${i}:`+d)}async function testCalendarJump(e){var t,a,n=document.getElementById("testTimestamp"),n=parseInt(n.value);isNaN(n)||n<=0?alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´æˆ³ï¼ˆUnixæ—¶é—´æˆ³ï¼Œç§’ä¸ºå•ä½ï¼‰"):(t=new Date(1e3*n).toLocaleString("zh-CN"),a=1===e?"æ—¥å†":"æ—¶é’Ÿ",confirm(`ç¡®è®¤è¦å°†è®¾å¤‡æ—¶é—´è®¾ç½®ä¸º:
${t}
å¹¶åˆ‡æ¢åˆ°${a}æ¨¡å¼?`)&&(n=new Uint8Array([n>>24&255,n>>16&255,n>>8&255,255&n,-(new Date).getTimezoneOffset()/60,e]),await write(EpdCmd.SET_TIME,n))&&(addLog("æµ‹è¯•æ—¶é—´å·²è®¾ç½®: "+t),addLog(`æ¨¡å¼: ${a}æ¨¡å¼`),addLog("å±å¹•åˆ·æ–°å®Œæˆå‰è¯·ä¸è¦æ“ä½œã€‚")))}async function sendcmd(){var e=document.getElementById("cmdTXT").value;""!=e&&await write((e=hex2bytes(e))[0],1<e.length?e.slice(1):null)}function convertUC8159(t,a){var n=t.length,i=new Uint8Array(4*n);let d=0,o,r,l;for(let e=0;e<n;e++){o=t[e],r=a[e];for(let e=0;e<8;e++)l=(l=0==(128&r)?4:0==(128&o)?0:3)<<4&255,o=o<<1&255,r=r<<1&255,e++,0==(128&r)?l|=4:0==(128&o)?l|=0:l|=3,o=o<<1&255,r=r<<1&255,i[d++]=l}return i}async function sendimg(){if(cropManager.isCropMode())alert("è¯·å…ˆå®Œæˆå›¾ç‰‡è£å‰ªï¼å‘é€å·²å–æ¶ˆã€‚");else{var t=document.getElementById("imageFile"),t=!!(t&&t.files&&0<t.files.length);let e=!1;!t&&void 0!==paintManager&&paintManager&&(n=paintManager.scheduleData&&0<paintManager.scheduleData.length,i=paintManager.todoData&&0<paintManager.todoData.length,a=!!paintManager.cardData,d=!!paintManager.wifiData,e=n||i||a||d)&&(addLog((n?"è¯¾è¡¨":i?"å¾…åŠ":d?"WiFi":"åç‰‡")+"å‘é€ï¼šé‡ç»˜ç”»å¸ƒï¼ˆç¦ç”¨æŠ–åŠ¨/å¯¹æ¯”åº¦ï¼Œç›´æ¥æŒ‰æ¸²æŸ“ç»“æœå‘é€ï¼‰"),paintManager.redrawAll()),t&&!e&&(void 0!==_pendingDitherJob&&_pendingDitherJob&&("idle"===_pendingDitherJob.type&&"function"==typeof cancelIdleCallback?cancelIdleCallback(_pendingDitherJob.id):"timeout"===_pendingDitherJob.type&&clearTimeout(_pendingDitherJob.id),_pendingDitherJob=null),convertDithering());var a=document.getElementById("canvasSize").value,n=document.getElementById("ditherMode").value,i=document.getElementById("epddriver"),d=i.options[i.selectedIndex];if((d.getAttribute("data-size")===a||confirm("è­¦å‘Šï¼šç”»å¸ƒå°ºå¯¸å’Œé©±åŠ¨ä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ"))&&(d.getAttribute("data-color")===n||confirm("è­¦å‘Šï¼šé¢œè‰²æ¨¡å¼å’Œé©±åŠ¨ä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ"))){startTime=(new Date).getTime();let e=document.getElementById("status");e.parentElement.style.display="block";t=ctx.getImageData(0,0,canvas.width,canvas.height),a=processImageData(t,n);if(updateButtonStatus(!0),await write(EpdCmd.INIT),"fourColor"===n)await writeImage(a,"color");else if("threeColor"===n){d=Math.floor(a.length/2),t=a.slice(0,d),d=a.slice(d);"08"===i.value||"09"===i.value?await writeImage(convertUC8159(t,d),"bw"):(await writeImage(t,"bw"),await writeImage(d,"red"))}else{if("blackWhiteColor"!==n)return addLog("å½“å‰å›ºä»¶ä¸æ”¯æŒæ­¤é¢œè‰²æ¨¡å¼ã€‚"),void updateButtonStatus();"08"===i.value||"09"===i.value?await writeImage(convertUC8159(a,new Uint8Array(a.length).fill(255)),"bw"):await writeImage(a,"bw")}await write(EpdCmd.REFRESH),updateButtonStatus();t=((new Date).getTime()-startTime)/1e3;addLog(`å‘é€å®Œæˆï¼è€—æ—¶: ${t}s`),setStatus(`å‘é€å®Œæˆï¼è€—æ—¶: ${t}s`),addLog("å±å¹•åˆ·æ–°å®Œæˆå‰è¯·ä¸è¦æ“ä½œã€‚"),setTimeout(()=>{e.parentElement.style.display="none"},5e3)}}}function downloadDataArray(){if(cropManager.isCropMode())alert("è¯·å…ˆå®Œæˆå›¾ç‰‡è£å‰ªï¼ä¸‹è½½å·²å–æ¶ˆã€‚");else{void 0!==paintManager&&paintManager&&(paintManager.scheduleData&&0<paintManager.scheduleData.length||paintManager.todoData&&0<paintManager.todoData.length||!!paintManager.cardData||!!paintManager.wifiData)&&(addLog((0<paintManager.scheduleData?.length?"è¯¾è¡¨":0<paintManager.todoData?.length?"å¾…åŠ":paintManager.cardData?"åç‰‡":"WiFi")+"ä¸‹è½½ï¼šé‡ç»˜ç”»å¸ƒï¼ˆç¦ç”¨æŠ–åŠ¨/å¯¹æ¯”åº¦ï¼Œç›´æ¥å¯¼å‡ºPCFæ¸²æŸ“ç»“æœï¼‰"),paintManager.redrawAll());var e=document.getElementById("ditherMode").value,t=ctx.getImageData(0,0,canvas.width,canvas.height),a=processImageData(t,e);if("sixColor"===e&&a.length!==canvas.width*canvas.height)console.log(`é”™è¯¯ï¼šé¢„æœŸ${canvas.width*canvas.height}å­—èŠ‚ï¼Œä½†å¾—åˆ°${a.length}å­—èŠ‚`),addLog("æ•°ç»„å¤§å°ä¸åŒ¹é…ã€‚è¯·æ£€æŸ¥å›¾åƒå°ºå¯¸å’Œæ¨¡å¼ã€‚");else{var n=[];for(let e=0;e<a.length;e++){var i=(255&a[e]).toString(16).padStart(2,"0");n.push("0x"+i)}var d=[];for(let e=0;e<n.length;e+=16)d.push(n.slice(e,e+16).join(", "));t="sixColor"===e?0:"fourColor"===e?1:"blackWhiteColor"===e?2:3,e=["const uint8_t imageData[] PROGMEM = {",d.join(",\n"),"};",`const uint16_t imageWidth = ${canvas.width};`,`const uint16_t imageHeight = ${canvas.height};`,`const uint8_t colorMode = ${t};`].join("\n"),t=new Blob([e],{type:"text/plain"}),e=document.createElement("a");e.download="imagedata.h",e.href=URL.createObjectURL(t),e.click(),URL.revokeObjectURL(e.href)}}}function updateButtonStatus(e=!1){var t=null!=gattServer&&gattServer.connected,e=!e&&t?null:"disabled",t=(document.getElementById("reconnectbutton").disabled=null==gattServer||gattServer.connected?"disabled":null,document.getElementById("sendcmdbutton").disabled=e,document.getElementById("calendarmodebutton").disabled=e,document.getElementById("clockmodebutton").disabled=e,document.getElementById("clearscreenbutton").disabled=e,document.getElementById("sendimgbutton").disabled=e,document.getElementById("setDriverbutton").disabled=e,document.getElementById("syncholidaybutton").disabled=e,document.querySelector('button[onclick="syncAndShowCalendar()"]'));t&&(t.disabled=e)}function disconnect(){updateButtonStatus(),resetVariables(),addLog("å·²æ–­å¼€è¿æ¥."),document.getElementById("connectbutton").innerHTML="è¿æ¥"}async function filterConnect(){await preConnect(!0,!0)}async function preConnect(e=!1,t=!1){if(null!=gattServer&&gattServer.connected){if(null!=bleDevice&&bleDevice.gatt.connected&&bleDevice.gatt.disconnect(),!t)return;await new Promise(e=>setTimeout(e,300))}resetVariables();try{var a=document.getElementById("blenamefilter"),n=a?.value.trim(),i=(a&&a.blur(),{optionalServices:["62750001-d828-918d-fb46-b6c11c675aec"]});if(e&&n&&0<n.length){let t=n.toUpperCase();var d=["NRF_EPD_","EPD_"];i.filters=d.map(e=>({namePrefix:e+t})),addLog(`æŒ‰åç§°è¿‡æ»¤: NRF_EPD_${t} æˆ– EPD_`+t)}else i.acceptAllDevices=!0;bleDevice=await navigator.bluetooth.requestDevice(i)}catch(e){return e&&("NotFoundError"===e.name||e.message&&e.message.includes("User cancelled"))?void addLog("å·²å–æ¶ˆè®¾å¤‡é€‰æ‹©ã€‚"):(console.error(e),e.message&&addLog("requestDevice: "+e.message),addLog("è¯·æ£€æŸ¥è“ç‰™æ˜¯å¦å·²å¼€å¯ï¼Œä¸”ä½¿ç”¨çš„æµè§ˆå™¨æ”¯æŒè“ç‰™ï¼å»ºè®®ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ï¼š"),addLog("â€¢ ç”µè„‘: Chrome/Edge"),addLog("â€¢ Android: Chrome/Edge"),void addLog("â€¢ iOS: Bluefy æµè§ˆå™¨"))}await bleDevice.addEventListener("gattserverdisconnected",disconnect),setTimeout(async function(){await connect()},300)}async function reConnect(){null!=bleDevice&&bleDevice.gatt.connected&&bleDevice.gatt.disconnect(),resetVariables(),addLog("æ­£åœ¨é‡è¿"),setTimeout(async function(){await connect()},300)}function handleNotify(e,t){var a,e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);0==t?(addLog("æ”¶åˆ°é…ç½®ï¼š"+bytes2hex(e)),t=document.getElementById("epdpins"),a=document.getElementById("epddriver"),t.value=bytes2hex(e.slice(0,7)),10<e.length&&(t.value+=bytes2hex(e.slice(10,11))),a.value=bytes2hex(e.slice(7,8)),updateDitcherOptions()):(addLog(t=(textDecoder=null==textDecoder?new TextDecoder:textDecoder).decode(e),"â‡“"),t.startsWith("mtu=")&&4<t.length?(a=parseInt(t.substring(4)),addLog("MTU å·²æ›´æ–°ä¸º: "+(document.getElementById("mtusize").value=a))):t.startsWith("t=")&&2<t.length&&(e=parseInt(t.substring(2))+60*(new Date).getTimezoneOffset(),addLog("è¿œç«¯æ—¶é—´: "+new Date(1e3*e).toLocaleString()),addLog("æœ¬åœ°æ—¶é—´: "+(new Date).toLocaleString())))}async function connect(){if(null!=bleDevice&&null==epdCharacteristic){try{addLog("æ­£åœ¨è¿æ¥: "+bleDevice.name),gattServer=await bleDevice.gatt.connect(),addLog("  æ‰¾åˆ° GATT Server"),epdService=await gattServer.getPrimaryService("62750001-d828-918d-fb46-b6c11c675aec"),addLog("  æ‰¾åˆ° EPD Service"),epdCharacteristic=await epdService.getCharacteristic("62750002-d828-918d-fb46-b6c11c675aec"),addLog("  æ‰¾åˆ° Characteristic")}catch(e){return console.error(e),e.message&&addLog("connect: "+e.message),void disconnect()}try{var e=await(await epdService.getCharacteristic("62750003-d828-918d-fb46-b6c11c675aec")).readValue();addLog("å›ºä»¶ç‰ˆæœ¬: 0x"+(appVersion=e.getUint8(0)).toString(16))}catch(e){console.error(e),appVersion=21}if(appVersion<22){let e="https://tsl0922.github.io/EPD-nRF5/v1.5";alert("!!!æ³¨æ„!!!\nå½“å‰å›ºä»¶ç‰ˆæœ¬è¿‡ä½ï¼Œå¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½ï¼Œå»ºè®®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"),confirm("æ˜¯å¦è®¿é—®æ—§ç‰ˆæœ¬ä¸Šä½æœºï¼Ÿ")&&(location.href=e),setTimeout(()=>{addLog("å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯è®¿é—®æ—§ç‰ˆæœ¬ä¸Šä½æœº: "+e)},500)}try{await epdCharacteristic.startNotifications(),epdCharacteristic.addEventListener("characteristicvaluechanged",e=>{handleNotify(e.target.value,msgIndex++)})}catch(e){console.error(e),e.message&&addLog("startNotifications: "+e.message)}await write(EpdCmd.INIT),document.getElementById("connectbutton").innerHTML="æ–­å¼€",updateButtonStatus()}}function setStatus(e){document.getElementById("status").innerHTML=e}function addLog(e,t=""){var a=document.getElementById("log"),n=new Date,n=String(n.getHours()).padStart(2,"0")+":"+String(n.getMinutes()).padStart(2,"0")+":"+String(n.getSeconds()).padStart(2,"0")+" ",i=document.createElement("div"),d=document.createElement("span");for(i.className="log-line",d.className="time",d.textContent=n,i.appendChild(d),""!==t&&((n=document.createElement("span")).className="action",n.innerHTML=t,i.appendChild(n)),i.appendChild(document.createTextNode(e)),a.appendChild(i),a.scrollTop=a.scrollHeight;20<a.childNodes.length;)a.removeChild(a.firstChild)}function clearLog(){document.getElementById("log").innerHTML=""}function fillCanvas(e){ctx.fillStyle=e,ctx.fillRect(0,0,canvas.width,canvas.height)}function setCanvasTitle(e){var t=document.querySelector(".canvas-title");t&&(t.innerText=e,t.style.display=e&&""!==e?"block":"none")}function updateImage(){var t=document.getElementById("imageFile");if(0==t.files.length)fillCanvas("white");else{let e=new Image;e.onload=function(){URL.revokeObjectURL(this.src),e.width/e.height==canvas.width/canvas.height?(cropManager.isCropMode()&&cropManager.exitCropMode(),ctx.drawImage(e,0,0,e.width,e.height,0,0,canvas.width,canvas.height),scheduleConvertDithering()):(alert(`å›¾ç‰‡å®½é«˜æ¯”ä¾‹ä¸ç”»å¸ƒä¸åŒ¹é…ï¼Œå°†è¿›å…¥è£å‰ªæ¨¡å¼ã€‚
è¯·æ”¾å¤§å›¾ç‰‡åç§»åŠ¨å›¾ç‰‡ä½¿å…¶å……æ»¡ç”»å¸ƒ, å†ç‚¹å‡»"å®Œæˆ"æŒ‰é’®ã€‚`),paintManager.setActiveTool(null,""),cropManager.initializeCrop())},e.src=URL.createObjectURL(t.files[0])}}function updateCanvasSize(){let t=document.getElementById("canvasSize").value;var e=canvasSizes.find(e=>e.name===t);canvas.width=e.width,canvas.height=e.height,updateImage()}function updateDitcherOptions(){var e=document.getElementById("epddriver"),e=e.options[e.selectedIndex],t=e.getAttribute("data-color"),e=e.getAttribute("data-size");t&&(document.getElementById("ditherMode").value=t),e&&(document.getElementById("canvasSize").value=e),updateCanvasSize()}function rotateCanvas(){var e=canvas.width,t=canvas.height,a=ctx.getImageData(0,0,e,t),n=(canvas.width=t,canvas.height=e,document.createElement("canvas"));n.width=e,n.height=t,n.getContext("2d").putImageData(a,0,0),ctx.translate(canvas.width/2,canvas.height/2),ctx.rotate(90*Math.PI/180),ctx.drawImage(n,-e/2,-t/2),ctx.setTransform(1,0,0,1,0,0),paintManager.clearHistory(),paintManager.clearElements(),paintManager.saveToHistory()}function clearCanvas(){return!!confirm("æ¸…é™¤ç”»å¸ƒå†…å®¹?")&&(fillCanvas("white"),paintManager.clearElements(),cropManager.isCropMode()&&cropManager.exitCropMode(),paintManager.saveToHistory(),!0)}function convertDithering(){var e=document.getElementById("imageFile");if(!!!(e&&e.files&&0<e.files.length)&&void 0!==paintManager&&paintManager){var e=paintManager.scheduleData&&0<paintManager.scheduleData.length,t=paintManager.todoData&&0<paintManager.todoData.length,a=!!paintManager.cardData,n=!!paintManager.wifiData;if(e||t||a||n)return void addLog((e?"è¯¾è¡¨":t?"å¾…åŠ":n?"WiFi":"åç‰‡")+"æ¨¡å¼ï¼šå·²ç¦ç”¨æŠ–åŠ¨/å¯¹æ¯”åº¦è°ƒæ•´ï¼ˆç›´æ¥å‘é€æ¸²æŸ“ç»“æœï¼‰")}paintManager.redrawTextElements(),paintManager.redrawLineSegments();a=parseFloat(document.getElementById("ditherContrast").value),e=ctx.getImageData(0,0,canvas.width,canvas.height),t=new ImageData(new Uint8ClampedArray(e.data),e.width,e.height),adjustContrast(t,a),n=document.getElementById("ditherAlg").value,e=parseFloat(document.getElementById("ditherStrength").value),a=document.getElementById("ditherMode").value,t=processImageData(ditherImage(t,n,e,a),a),n=decodeProcessedData(t,canvas.width,canvas.height,a);ctx.putImageData(n,0,0),paintManager.saveToHistory()}function applyDither(){cropManager.finishCrop(()=>scheduleConvertDithering())}let _pendingDitherJob=null;function scheduleConvertDithering(){_pendingDitherJob&&("idle"===_pendingDitherJob.type&&"function"==typeof cancelIdleCallback?cancelIdleCallback(_pendingDitherJob.id):"raf"===_pendingDitherJob.type&&cancelAnimationFrame(_pendingDitherJob.id),_pendingDitherJob=null);var e=()=>{_pendingDitherJob=null,"function"==typeof convertDithering&&convertDithering()};_pendingDitherJob="function"==typeof requestIdleCallback?{type:"idle",id:requestIdleCallback(e,{timeout:200})}:{type:"raf",id:requestAnimationFrame(e)}}function initEventHandlers(){document.getElementById("ditherStrength").addEventListener("input",e=>{document.getElementById("ditherStrengthValue").innerText=parseFloat(e.target.value).toFixed(1),applyDither()}),document.getElementById("ditherContrast").addEventListener("input",e=>{document.getElementById("ditherContrastValue").innerText=parseFloat(e.target.value).toFixed(1),applyDither()})}function checkDebugMode(){var e=document.getElementById("debug-toggle");"true"===new URLSearchParams(window.location.search).get("debug")?(document.body.classList.add("dark-mode"),e&&(e.innerHTML="æ­£å¸¸æ¨¡å¼",e.setAttribute("href",window.location.pathname)),addLog("æ³¨æ„ï¼šå¼€å‘æ¨¡å¼åŠŸèƒ½å·²å¼€å¯ï¼ä¸æ‡‚è¯·ä¸è¦éšæ„ä¿®æ”¹ï¼Œå¦åˆ™åæœè‡ªè´Ÿï¼")):(document.body.classList.remove("dark-mode"),e&&(e.innerHTML="å¼€å‘æ¨¡å¼",e.setAttribute("href",window.location.pathname+"?debug=true")))}function initImageEditor(){let t=document.getElementById("image-mode"),a=document.getElementById("image-panel"),n=document.getElementById("schedule-editor"),i=document.getElementById("todo-panel"),d=document.getElementById("card-panel"),o=document.getElementById("wifi-panel"),r=document.getElementById("schedule-mode"),l=document.getElementById("todo-mode"),c=document.getElementById("card-mode"),s=document.getElementById("wifi-mode");t&&t.addEventListener("click",()=>{var e=a&&"none"!==a.style.display;e=!e,a&&(a.style.display=e?"":"none"),t&&t.classList.toggle("active",e),e&&(n&&(n.style.display="none"),i&&(i.style.display="none"),d&&(d.style.display="none"),o&&(o.style.display="none"),(e=document.getElementById("schedule-panel"))&&(e.style.display="none"),r&&r.classList.remove("active"),l&&l.classList.remove("active"),c&&c.classList.remove("active"),s&&s.classList.remove("active"),void 0!==paintManager)&&paintManager&&(paintManager.scheduleData=null,paintManager.todoData=null,paintManager.cardData=null,paintManager.wifiData=null,paintManager.redrawAll())})}function getScheduleConfigFromInputs(){return{days:Math.max(1,Math.min(7,parseInt(document.getElementById("schedule-days").value||"5",10))),classes:Math.max(1,Math.min(12,parseInt(document.getElementById("schedule-classes").value||"6",10))),fontSize:Math.max(8,Math.min(32,parseInt(document.getElementById("schedule-font-size").value||"12",10)))}}function getWeekdayLabels(e){return(void 0!==paintManager&&paintManager&&Array.isArray(paintManager.weekDays)?paintManager.weekDays:["å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­","å‘¨æ—¥"]).slice(0,e)}function captureScheduleEditorValues(){let i=new Map;var e=document.getElementById("schedule-table-container");return e&&e.querySelectorAll("tr[data-row]").forEach(e=>{let n=parseInt(e.getAttribute("data-row"),10);e.querySelectorAll("td[data-col]").forEach(e=>{var t=parseInt(e.getAttribute("data-col"),10),a=e.querySelector("input.schedule-cell-input"),e=e.querySelector("input.schedule-cell-red-checkbox"),a=a&&a.value||"",e=e?.checked?"#FF0000":"#000000";i.set(n+","+t,{text:a,color:e})})}),i}function renderScheduleEditorTable(){var e=document.getElementById("schedule-editor");let t=document.getElementById("schedule-table-container");if(e&&t){var{days:i,classes:a}=getScheduleConfigFromInputs(),n=getWeekdayLabels(i),d=captureScheduleEditorValues(),o=document.createElement("table"),r=(o.className="schedule-editor-table",document.createElement("thead")),l=document.createElement("tr"),c=document.createElement("th");c.textContent="",l.appendChild(c);for(let e=1;e<=i;e++){var s=document.createElement("th");s.textContent=n[e-1],l.appendChild(s)}r.appendChild(l),o.appendChild(r);var g=document.createElement("tbody");for(let n=1;n<=a;n++){var u=document.createElement("tr"),m=(u.setAttribute("data-row",String(n)),document.createElement("th"));m.textContent=`ç¬¬${n}èŠ‚`,u.appendChild(m);for(let a=1;a<=i;a++){var p=document.createElement("td"),h=(p.setAttribute("data-col",String(a)),p.style.padding="2px",d.get(n+","+a)),y=h?.text||"",h=h?.color||"#000000",v="#FF0000"===h;let e=document.createElement("div"),t=(e.style.display="flex",e.style.gap="2px",e.style.alignItems="center",document.createElement("input"));t.type="text",t.className="schedule-cell-input",t.placeholder="",t.value=y,t.style.flex="1",t.style.minWidth="40px",t.style.color=h;y=document.createElement("input");y.type="checkbox",y.className="schedule-cell-red-checkbox",y.checked=v,y.title="æ ‡çº¢",y.style.width="16px",y.style.height="16px",y.style.cursor="pointer",y.style.accentColor="#FF0000",y.addEventListener("change",function(){var e=this.checked?"#FF0000":"#000000";t.style.color=e,previewSchedule()}),t.addEventListener("input",function(){previewSchedule()}),e.appendChild(t),e.appendChild(y),p.appendChild(e),u.appendChild(p)}g.appendChild(u)}o.appendChild(g),t.innerHTML="",t.appendChild(o);c=document.createElement("div");c.style.marginTop="8px",c.style.fontSize="12px",c.style.color="#666",c.innerHTML="ğŸ’¡ æç¤ºï¼šå‹¾é€‰å¤é€‰æ¡†å¯å°†è¯¥è¯¾ç¨‹æ–‡å­—æ ‡çº¢",t.appendChild(c),e.style.display=""}}function clearScheduleEditorInputs(){var e=document.getElementById("schedule-table-container");e&&e.querySelectorAll("input.schedule-cell-input").forEach(e=>e.value="")}function buildScheduleDataFromEditor(){let{days:i,classes:a}=getScheduleConfigFromInputs();var n=getWeekdayLabels(i),e=document.getElementById("schedule-table-container");let d=[];for(let t=0;t<=a;t++){d[t]=[];for(let e=0;e<=i;e++)0===t&&0===e?d[t][e]={text:"",color:"#000000"}:0===t?d[t][e]={text:n[e-1],color:"#000000"}:0===e?d[t][e]={text:`ç¬¬${t}èŠ‚`,color:"#000000"}:d[t][e]={text:"",color:"#000000"}}return e&&e.querySelectorAll("tr[data-row]").forEach(e=>{let n=parseInt(e.getAttribute("data-row"),10);!Number.isFinite(n)||n<1||n>a||e.querySelectorAll("td[data-col]").forEach(e=>{var t,a=parseInt(e.getAttribute("data-col"),10);!Number.isFinite(a)||a<1||a>i||(t=e.querySelector("input.schedule-cell-input"),e=e.querySelector("input.schedule-cell-red-checkbox"),t=t?(t.value||"").trim():"",e=e?.checked?"#FF0000":"#000000",d[n][a]={text:t,color:e})})}),d}async function previewSchedule(){var e,t,a;void 0!==paintManager&&paintManager?({days:e,classes:t,fontSize:a}=getScheduleConfigFromInputs(),await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleDays=e,paintManager.scheduleClasses=t,paintManager.scheduleFontSize=a,paintManager.calculateScheduleDimensions(),paintManager.scheduleData=buildScheduleDataFromEditor(),paintManager.redrawAll(),paintManager.saveToHistory()):alert("ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•é¢„è§ˆè¯¾è¡¨")}async function syncScheduleToEPD(){var e,t,a;void 0!==paintManager&&paintManager?({days:e,classes:t,fontSize:a}=getScheduleConfigFromInputs(),await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleDays=e,paintManager.scheduleClasses=t,paintManager.scheduleFontSize=a,paintManager.calculateScheduleDimensions(),paintManager.scheduleData=buildScheduleDataFromEditor(),paintManager.redrawAll(),paintManager.saveToHistory(),await sendimg()):alert("ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥è¯¾è¡¨")}function initScheduleEditor(){let t=document.getElementById("schedule-mode"),a=document.getElementById("schedule-panel"),n=document.getElementById("image-panel"),i=document.getElementById("todo-panel"),d=document.getElementById("card-panel"),o=document.getElementById("wifi-panel"),r=document.getElementById("image-mode"),l=document.getElementById("todo-mode"),c=document.getElementById("card-mode"),s=document.getElementById("wifi-mode"),e=(t&&t.addEventListener("click",()=>{var e=a&&"none"!==a.style.display;e=!e,a&&(a.style.display=e?"":"none"),t&&t.classList.toggle("active",e),e&&(n&&(n.style.display="none"),i&&(i.style.display="none"),d&&(d.style.display="none"),o&&(o.style.display="none"),r&&r.classList.remove("active"),l&&l.classList.remove("active"),c&&c.classList.remove("active"),s&&s.classList.remove("active"),void 0!==paintManager)&&paintManager&&(paintManager.todoData=null,paintManager.cardData=null,paintManager.wifiData=null,paintManager.redrawAll())}),document.getElementById("create-schedule-btn"));var g=document.getElementById("schedule-sync-btn"),u=document.getElementById("schedule-clear-btn"),m=document.getElementById("schedule-days"),p=document.getElementById("schedule-classes"),h=document.getElementById("schedule-font-size"),y=(e&&(y=e.cloneNode(!0),e.parentNode.replaceChild(y,e),(e=y).addEventListener("click",async()=>{var e=document.getElementById("todo-editor"),e=(e&&(e.style.display="none"),document.getElementById("image-panel")),e=(e&&(e.style.display="none"),document.getElementById("image-mode"));e&&e.classList.remove("active"),void 0!==paintManager&&paintManager&&await paintManager.createSchedule(),renderScheduleEditorTable()})),g&&g.addEventListener("click",()=>{syncScheduleToEPD()}),u&&u.addEventListener("click",()=>{if(clearScheduleEditorInputs(),void 0!==paintManager&&paintManager&&paintManager.scheduleData&&0<paintManager.scheduleData.length){for(let t=1;t<paintManager.scheduleData.length;t++)for(let e=1;e<paintManager.scheduleData[t].length;e++)paintManager.scheduleData[t][e]="";paintManager.redrawAll(),paintManager.saveToHistory()}}),()=>{var e=document.getElementById("schedule-editor");e&&"none"!==e.style.display&&renderScheduleEditorTable()});m&&m.addEventListener("change",y),p&&p.addEventListener("change",y),h&&h.addEventListener("change",y)}function getTodoConfigFromInputs(){return{count:Math.max(1,Math.min(30,parseInt(document.getElementById("todo-count").value||"8",10))),fontSize:Math.max(8,Math.min(32,parseInt(document.getElementById("todo-font-size").value||"12",10)))}}function captureTodoEditorValues(){let i=new Map;var e=document.getElementById("todo-table-container");return e&&e.querySelectorAll("tr[data-idx]").forEach(e=>{var t=parseInt(e.getAttribute("data-idx"),10),a=e.querySelector("input.todo-item-input")?.value||"",n=!!e.querySelector("input.todo-done-checkbox")?.checked,e=!!e.querySelector("input.todo-item-red-checkbox")?.checked?"#FF0000":"#000000";i.set(t,{text:a,done:n,color:e})}),i}function renderTodoEditorTable(){var e=document.getElementById("todo-editor"),t=document.getElementById("todo-table-container");if(e&&t){var a=getTodoConfigFromInputs().count,n=captureTodoEditorValues(),i=document.createElement("table"),d=(i.className="todo-editor-table",document.createElement("thead")),o=document.createElement("tr"),r=document.createElement("th"),l=(r.textContent="#",r.style.width="44px",document.createElement("th")),c=(l.textContent="å®Œæˆ",l.style.width="64px",document.createElement("th")),s=(c.textContent="å¾…åŠäº‹é¡¹",document.createElement("th")),g=(s.textContent="æ ‡çº¢",s.style.width="64px",o.appendChild(r),o.appendChild(l),o.appendChild(c),o.appendChild(s),d.appendChild(o),i.appendChild(d),document.createElement("tbody"));for(let e=0;e<a;e++){var u=document.createElement("tr"),m=(u.setAttribute("data-idx",String(e)),document.createElement("td")),p=(m.textContent=String(e+1),m.style.background="#f6f7f9",m.style.fontWeight="600",document.createElement("td")),h=document.createElement("input"),y=(h.type="checkbox",h.className="todo-done-checkbox",n.get(e)),h=(h.checked=!!y&&!!y.done,h.addEventListener("change",function(){previewTodo()}),p.appendChild(h),document.createElement("td"));let t=document.createElement("input");t.type="text",t.className="todo-item-input",t.value=y&&y.text||"",t.style.color=y?.color||"#000000",t.addEventListener("input",function(){previewTodo()}),h.appendChild(t);var v=document.createElement("td"),f=document.createElement("input");f.type="checkbox",f.className="todo-item-red-checkbox",f.checked="#FF0000"===y?.color,f.title="æ ‡çº¢",f.style.width="16px",f.style.height="16px",f.style.cursor="pointer",f.style.accentColor="#FF0000",f.addEventListener("change",function(){var e=this.checked?"#FF0000":"#000000";t.style.color=e,previewTodo()}),v.appendChild(f),u.appendChild(m),u.appendChild(p),u.appendChild(h),u.appendChild(v),g.appendChild(u)}i.appendChild(g),t.innerHTML="",t.appendChild(i);r=document.createElement("div");r.style.marginTop="8px",r.style.fontSize="12px",r.style.color="#666",r.innerHTML="ğŸ’¡ æç¤ºï¼šå‹¾é€‰å¤é€‰æ¡†å¯å°†è¯¥å¾…åŠäº‹é¡¹æ–‡å­—æ ‡çº¢",t.appendChild(r),e.style.display=""}}function clearTodoEditorInputs(){var e=document.getElementById("todo-table-container");e&&(e.querySelectorAll("input.todo-item-input").forEach(e=>e.value=""),e.querySelectorAll("input.todo-done-checkbox").forEach(e=>e.checked=!1))}function buildTodoDataFromEditor(){let i=getTodoConfigFromInputs().count;var e=document.getElementById("todo-table-container");let d=[];for(let e=0;e<i;e++)d.push({text:"",done:!1,color:"#000000"});return e&&e.querySelectorAll("tr[data-idx]").forEach(e=>{var t,a,n=parseInt(e.getAttribute("data-idx"),10);!Number.isFinite(n)||n<0||n>=i||(t=e.querySelector("input.todo-item-input")?.value||"",a=!!e.querySelector("input.todo-done-checkbox")?.checked,e=!!e.querySelector("input.todo-item-red-checkbox")?.checked?"#FF0000":"#000000",d[n]={text:t.trim(),done:a,color:e})}),d}async function previewTodo(){var e,t;void 0!==paintManager&&paintManager?({count:e,fontSize:t}=getTodoConfigFromInputs(),await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleData=null,paintManager.cardData=null,paintManager.wifiData=null,paintManager.todoCount=e,paintManager.todoFontSize=t,paintManager.calculateTodoDimensions(),paintManager.todoData=buildTodoDataFromEditor(),paintManager.redrawAll(),paintManager.saveToHistory()):alert("ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•é¢„è§ˆå¾…åŠäº‹é¡¹")}async function syncTodoToEPD(){var e,t;void 0!==paintManager&&paintManager?({count:e,fontSize:t}=getTodoConfigFromInputs(),await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleData=null,paintManager.cardData=null,paintManager.wifiData=null,paintManager.todoCount=e,paintManager.todoFontSize=t,paintManager.calculateTodoDimensions(),paintManager.todoData=buildTodoDataFromEditor(),paintManager.redrawAll(),paintManager.saveToHistory(),await sendimg()):alert("ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥å¾…åŠäº‹é¡¹")}function initTodoEditor(){let a=document.getElementById("todo-mode"),n=document.getElementById("todo-panel"),i=document.getElementById("card-panel"),d=document.getElementById("card-mode"),o=document.getElementById("wifi-panel"),r=document.getElementById("wifi-mode");var e=document.getElementById("create-todo-btn"),t=document.getElementById("todo-sync-btn"),l=document.getElementById("todo-clear-btn"),c=document.getElementById("todo-count"),s=document.getElementById("todo-font-size");a&&a.addEventListener("click",()=>{var e,t=n&&"none"!==n.style.display;t=!t,n&&(n.style.display=t?"":"none"),a&&a.classList.toggle("active",t),t&&(i&&(i.style.display="none"),d&&d.classList.remove("active"),o&&(o.style.display="none"),r&&r.classList.remove("active"),(e=document.getElementById("schedule-panel"))&&(e.style.display="none"),(e=document.getElementById("schedule-mode"))&&e.classList.remove("active"),(e=document.getElementById("image-panel"))&&(e.style.display="none"),(e=document.getElementById("image-mode"))&&e.classList.remove("active"),void 0!==paintManager)&&paintManager&&(paintManager.scheduleData=null,paintManager.cardData=null,paintManager.wifiData=null,paintManager.redrawAll()),t&&void 0!==paintManager&&paintManager&&"function"==typeof paintManager.setActiveTool&&"schedule"===paintManager.currentTool&&paintManager.setActiveTool(null,""),t||(e=document.getElementById("todo-editor"))&&(e.style.display="none")}),e&&e.addEventListener("click",async()=>{var e=document.getElementById("schedule-editor"),e=(e&&(e.style.display="none"),document.getElementById("image-panel")),e=(e&&(e.style.display="none"),document.getElementById("image-mode"));e&&e.classList.remove("active"),void 0!==paintManager&&paintManager&&"function"==typeof paintManager.createTodoList&&await paintManager.createTodoList(),renderTodoEditorTable()}),t&&t.addEventListener("click",()=>{syncTodoToEPD()}),l&&l.addEventListener("click",()=>{clearTodoEditorInputs(),void 0!==paintManager&&paintManager&&paintManager.todoData&&0<paintManager.todoData.length&&(paintManager.todoData.forEach(e=>{e.text="",e.done=!1}),paintManager.redrawAll(),paintManager.saveToHistory())});e=()=>{var e=document.getElementById("todo-editor");e&&"none"!==e.style.display&&renderTodoEditorTable()};c&&c.addEventListener("change",e),s&&s.addEventListener("change",e)}function getCardDataFromInputs(){var e=e=>(document.getElementById(e)?.value||"").trim(),e={name:e("card-name"),title:e("card-title"),phone:e("card-phone"),email:e("card-email"),website:e("card-website"),footer:e("card-footer")};return Object.values(e).some(e=>0<(e||"").trim().length)?e:null}function clearCardInputs(){["card-name","card-title","card-phone","card-email","card-website","card-footer"].forEach(e=>{e=document.getElementById(e);e&&(e.value="")})}document.body.onload=()=>{textDecoder=null,canvas=document.getElementById("canvas"),(ctx=canvas.getContext("2d",{willReadFrequently:!0})).fillStyle="white",ctx.fillRect(0,0,canvas.width,canvas.height),paintManager=new PaintManager(canvas,ctx),cropManager=new CropManager(canvas,ctx,paintManager),paintManager.initPaintTools(),cropManager.initCropTools(),initEventHandlers(),updateButtonStatus(),checkDebugMode();var e=()=>{initImageEditor(),initScheduleEditor(),initTodoEditor(),initCardEditor(),initWifiEditor()};"function"==typeof requestIdleCallback?requestIdleCallback(e,{timeout:200}):setTimeout(e,0)};let cardCanvasPreviewTimer=null;function scheduleCardCanvasPreviewUpdate(){cardCanvasPreviewTimer&&clearTimeout(cardCanvasPreviewTimer),cardCanvasPreviewTimer=setTimeout(()=>{updateCardCanvasPreview({saveHistory:!1,onlyWhenPanelVisible:!0})},120)}async function updateCardCanvasPreview(e={}){var{saveHistory:e=!1,onlyWhenPanelVisible:t=!0}=e,a=document.getElementById("card-panel"),a=a&&"none"!==a.style.display;if((!t||a)&&void 0!==paintManager&&paintManager)try{await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleData=null,paintManager.todoData=null,paintManager.wifiData=null,paintManager.cardData=getCardDataFromInputs(),paintManager.redrawAll(),e&&"function"==typeof paintManager.saveToHistory&&paintManager.saveToHistory()}catch(e){}}async function syncCardToEPD(){void 0!==paintManager&&paintManager?(await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleData=null,paintManager.todoData=null,paintManager.wifiData=null,paintManager.cardData=getCardDataFromInputs(),paintManager.redrawAll(),paintManager.saveToHistory(),await sendimg()):alert("ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥åç‰‡")}function initCardEditor(){let n=document.getElementById("card-mode"),i=document.getElementById("card-panel"),d=document.getElementById("wifi-panel"),o=document.getElementById("wifi-mode"),r=document.getElementById("todo-panel"),l=document.getElementById("todo-mode");var e=document.getElementById("card-sync-btn"),t=document.getElementById("card-clear-btn");n&&n.addEventListener("click",()=>{var e,t,a=i&&"none"!==i.style.display;e=!a,i&&(i.style.display=e?"":"none"),n&&n.classList.toggle("active",e),e&&(r&&(r.style.display="none"),l&&l.classList.remove("active"),d&&(d.style.display="none"),o&&o.classList.remove("active"),(t=document.getElementById("schedule-panel"))&&(t.style.display="none"),(t=document.getElementById("schedule-mode"))&&t.classList.remove("active"),(t=document.getElementById("image-panel"))&&(t.style.display="none"),(t=document.getElementById("image-mode"))&&t.classList.remove("active"),void 0!==paintManager)&&paintManager&&(paintManager.scheduleData=null,paintManager.todoData=null,paintManager.wifiData=null,paintManager.redrawAll()),e&&void 0!==paintManager&&paintManager&&"function"==typeof paintManager.setActiveTool&&"schedule"===paintManager.currentTool&&paintManager.setActiveTool(null,""),a||scheduleCardCanvasPreviewUpdate()}),e&&e.addEventListener("click",()=>{syncCardToEPD()}),t&&t.addEventListener("click",()=>{clearCardInputs(),void 0!==paintManager&&paintManager&&paintManager.cardData&&(paintManager.cardData=getCardDataFromInputs(),paintManager.redrawAll(),paintManager.saveToHistory()),scheduleCardCanvasPreviewUpdate()});["card-name","card-title","card-phone","card-email","card-website","card-footer"].forEach(e=>{e=document.getElementById(e);e&&e.addEventListener("input",()=>{scheduleCardCanvasPreviewUpdate()})}),scheduleCardCanvasPreviewUpdate()}function getWifiDataFromInputs(){var e=e=>(document.getElementById(e)?.value||"").trim(),t=e=>document.getElementById(e)?.placeholder||"",a=e("wifi-ssid")||t("wifi-ssid"),e=e("wifi-password")||t("wifi-password"),t=(document.getElementById("wifi-encryption")?.value||"WPA").trim(),n=!!document.getElementById("wifi-hidden")?.checked;return a?{ssid:a,password:e,encryption:t,hidden:n}:null}function buildWifiQrPayload(e){if(!e||!e.ssid)return"";var t=e=>((e||"")+"").trim(),a=e=>(e||"").replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/:/g,"\\:"),n=a(t(e.ssid)),i=t(e.encryption)||"WPA",d=!!e.hidden;let o=`WIFI:T:${i};S:${n};`;return"nopass"!==i&&(n=a(t(e.password)))&&(o+=`P:${n};`),d&&(o+="H:true;"),o+=";"}function renderWifiQrPreview(){var t=document.getElementById("wifi-qr"),e=document.getElementById("wifi-payload"),a=document.getElementById("wifi-meta-ssid"),n=document.getElementById("wifi-meta-enc"),i=document.getElementById("wifi-meta-hidden");if(t){var d=getWifiDataFromInputs(),o=buildWifiQrPayload(d);if(a&&(a.textContent=d?.ssid?d.ssid:"-"),n&&(n.textContent=d?.encryption?d.encryption:"-"),i&&(i.textContent=d?.ssid?d.hidden?"æ˜¯":"å¦":"-"),e&&(e.value=o||""),t.innerHTML="",o)if("function"!=typeof qrcode)t.innerHTML='<div style="color:#b00;font-size:12px;line-height:1.4;text-align:center;padding:12px;">äºŒç»´ç åº“æœªåŠ è½½</div>';else try{var r=qrcode(0,"H"),l=(r.addData(o),r.make(),r.createSvgTag({cellSize:4,margin:2,scalable:!0}));t.innerHTML=l}catch(e){t.innerHTML='<div style="color:#b00;font-size:12px;line-height:1.4;text-align:center;padding:12px;">ç”ŸæˆäºŒç»´ç å¤±è´¥</div>'}else t.innerHTML='<div style="color:#667;font-size:12px;line-height:1.4;text-align:center;padding:12px;">è¯·è¾“å…¥ç½‘ç»œå (SSID)<br/>ä»¥ç”ŸæˆäºŒç»´ç </div>'}}async function updateWifiCanvasPreview(e={}){var{saveHistory:e=!1,onlyWhenPanelVisible:t=!0}=e,a=document.getElementById("wifi-panel"),a=a&&"none"!==a.style.display;if((!t||a)&&void 0!==paintManager&&paintManager)try{await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleData=null,paintManager.todoData=null,paintManager.cardData=null,paintManager.wifiData=getWifiDataFromInputs(),paintManager.redrawAll(),e&&"function"==typeof paintManager.saveToHistory&&paintManager.saveToHistory()}catch(e){}}let wifiCanvasPreviewTimer=null;function scheduleWifiCanvasPreviewUpdate(){wifiCanvasPreviewTimer&&clearTimeout(wifiCanvasPreviewTimer),wifiCanvasPreviewTimer=setTimeout(()=>{updateWifiCanvasPreview({saveHistory:!1,onlyWhenPanelVisible:!0})},120)}function clearWifiInputs(){var e=document.getElementById("wifi-ssid"),t=document.getElementById("wifi-password"),a=document.getElementById("wifi-encryption"),n=document.getElementById("wifi-hidden");e&&(e.value=""),t&&(t.value=""),a&&(a.value="WPA"),n&&(n.checked=!1)}async function syncWifiToEPD(){void 0!==paintManager&&paintManager?(await paintManager.loadPCFFonts(),paintManager.lineSegments=[],paintManager.textElements=[],paintManager.scheduleData=null,paintManager.todoData=null,paintManager.cardData=null,paintManager.wifiData=getWifiDataFromInputs(),paintManager.redrawAll(),paintManager.saveToHistory(),await sendimg()):alert("ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥WiFiè¿æ¥")}function initWifiEditor(){let n=document.getElementById("wifi-mode"),i=document.getElementById("wifi-panel"),d=document.getElementById("todo-panel"),o=document.getElementById("todo-mode"),r=document.getElementById("card-panel"),l=document.getElementById("card-mode");var e=document.getElementById("wifi-sync"),t=document.getElementById("wifi-clear");let a=document.getElementById("wifi-toggle-pass");var c=document.getElementById("wifi-copy-payload");n&&n.addEventListener("click",()=>{var e,t,a=i&&"none"!==i.style.display;e=!a,i&&(i.style.display=e?"":"none"),n&&n.classList.toggle("active",e),e&&(d&&(d.style.display="none"),o&&o.classList.remove("active"),r&&(r.style.display="none"),l&&l.classList.remove("active"),(t=document.getElementById("schedule-panel"))&&(t.style.display="none"),(t=document.getElementById("schedule-mode"))&&t.classList.remove("active"),(t=document.getElementById("image-panel"))&&(t.style.display="none"),(t=document.getElementById("image-mode"))&&t.classList.remove("active"),void 0!==paintManager)&&paintManager&&(paintManager.scheduleData=null,paintManager.todoData=null,paintManager.cardData=null,paintManager.redrawAll()),e&&void 0!==paintManager&&paintManager&&"function"==typeof paintManager.setActiveTool&&"schedule"===paintManager.currentTool&&paintManager.setActiveTool(null,""),a||(renderWifiQrPreview(),scheduleWifiCanvasPreviewUpdate())}),e&&e.addEventListener("click",()=>{syncWifiToEPD(),renderWifiQrPreview(),scheduleWifiCanvasPreviewUpdate()}),t&&t.addEventListener("click",()=>{clearWifiInputs(),void 0!==paintManager&&paintManager&&paintManager.wifiData&&(paintManager.wifiData=getWifiDataFromInputs(),paintManager.redrawAll(),paintManager.saveToHistory()),renderWifiQrPreview(),scheduleWifiCanvasPreviewUpdate()}),a&&a.addEventListener("click",()=>{var e,t=document.getElementById("wifi-password");t&&(e="password"===t.type,t.type=e?"text":"password",a.textContent=e?"éšè—":"æ˜¾ç¤º")}),c&&c.addEventListener("click",async()=>{var t=document.getElementById("wifi-payload"),e=t?.value||"";if(e)try{await navigator.clipboard.writeText(e)}catch(e){try{t.focus(),t.select(),document.execCommand("copy")}catch(e){alert("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨é€‰æ‹©å†…å®¹å¤åˆ¶")}}});e=(e,t)=>{e=document.getElementById(e);e&&e.addEventListener(t,()=>{renderWifiQrPreview(),scheduleWifiCanvasPreviewUpdate()})};e("wifi-ssid","input"),e("wifi-password","input"),e("wifi-encryption","change"),e("wifi-hidden","change"),renderWifiQrPreview(),scheduleWifiCanvasPreviewUpdate()}async function loadHolidayJson(t){try{var e,a=await fetch(`holiday-cn/${t}.json`);return a.ok?(addLog(`æˆåŠŸåŠ è½½${t}å¹´å‡æœŸæ•°æ®ï¼Œå…±${(e=await a.json()).days.length}æ¡è®°å½•`),e):(addLog(`æœªæ‰¾åˆ°${t}å¹´çš„å‡æœŸæ•°æ®æ–‡ä»¶ (HTTP ${a.status})`),addLog(`è¯·ç¡®è®¤æ–‡ä»¶è·¯å¾„: holiday-cn/${t}.json`),null)}catch(e){return addLog("åŠ è½½å‡æœŸæ•°æ®å¤±è´¥: "+e.message),e.message.includes("Failed to fetch")&&(addLog("âš ï¸ å¯èƒ½çš„åŸå› :"),addLog("  1. è¯·é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ï¼ˆè€Œéfile://åè®®ï¼‰"),addLog(`  2. æ£€æŸ¥holiday-cn/${t}.jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨`)),null}}function convertJsonToDeviceFormat(e){var t,a=[];for(t of e.days){var n=t.date.split("-"),i=parseInt(n[1]),n=parseInt(n[2]),d=t.isOffDay?0:1;a.push(d<<12|i<<8|n)}return a}async function syncHolidayData(){var e=(new Date).getFullYear(),t=(addLog(`æ­£åœ¨åŠ è½½${e}å¹´çš„å‡æœŸæ•°æ®...`),await loadHolidayJson(e));if(t){var a=convertJsonToDeviceFormat(t);if(0===a.length)alert("æ²¡æœ‰æœ‰æ•ˆçš„å‡æœŸæ•°æ®ï¼");else if(128<a.length)alert("å‡æœŸæ•°æ®è¿‡å¤šï¼Œæœ€å¤šæ”¯æŒ128ä¸ªï¼");else if(confirm(`å³å°†åŒæ­¥${e}å¹´çš„å‡æœŸæ•°æ®åˆ°è®¾å¤‡
`+`å…±${a.length}ä¸ªå‡æœŸ/è°ƒä¼‘æ—¥
`+`æ•°æ®æ¥æº: holiday-cn

`+"ç¡®è®¤ç»§ç»­ï¼Ÿ")){var n=new Uint8Array(3+2*a.length);n[0]=e>>8&255,n[1]=255&e,n[2]=a.length;for(let e=0;e<a.length;e++)n[3+2*e]=a[e]>>8&255,n[3+2*e+1]=255&a[e];addLog(`æ­£åœ¨å‘é€ ${e} å¹´å‡æœŸæ•°æ®ï¼Œå…± ${a.length} ä¸ªå‡æœŸ...`),await write(EpdCmd.SET_HOLIDAYS,n)?(addLog("âœ… å‡æœŸæ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°è®¾å¤‡ï¼"),addLog("âœ” æ•°æ®å·²ä¿å­˜åˆ°NVDSï¼Œæ–­ç”µä¸ä¸¢å¤±")):addLog("âŒ å‡æœŸæ•°æ®å‘é€å¤±è´¥ï¼")}else addLog("ç”¨æˆ·å–æ¶ˆäº†åŒæ­¥æ“ä½œ")}else alert(`æ— æ³•åŠ è½½${e}å¹´çš„å‡æœŸæ•°æ®ï¼
è¯·ç¡®è®¤ holiday-cn/${e}.json æ–‡ä»¶å­˜åœ¨ã€‚`)}function showHolidayHelp(){document.getElementById("holidayHelpDialog").style.display="block",document.getElementById("holidayHelpOverlay").style.display="block"}function closeHolidayHelp(){document.getElementById("holidayHelpDialog").style.display="none",document.getElementById("holidayHelpOverlay").style.display="none"}async function syncAndShowCalendar(){var e=parseInt(document.getElementById("testYear").value);let t=parseInt(document.getElementById("testMonth").value);var a=document.getElementById("holidayTestInfo");if(!e||e<2007||2050<e)alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´ä»½ (2007-2050)");else if(!t||t<1||12<t)alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„æœˆä»½ (1-12)");else{addLog(`=== å‡æœŸæ—¥å†æµ‹è¯•: ${e}å¹´${t}æœˆ ===`),a.textContent=`æ­£åœ¨åŠ è½½ ${e} å¹´æ•°æ®...`;var n=await loadHolidayJson(e);if(n){var i,d=convertJsonToDeviceFormat(n),o=(0===d.length?(a.textContent=`âš ï¸ ${e} å¹´æ— å‡æœŸæ•°æ®`,addLog(`è­¦å‘Š: ${e}å¹´æ²¡æœ‰å‡æœŸæ•°æ®`)):a.textContent=`âœ… å·²åŠ è½½ ${d.length} ä¸ªå‡æœŸ`,new Uint8Array(3+2*d.length));o[0]=e>>8&255,o[1]=255&e,o[2]=d.length;for(let e=0;e<d.length;e++)o[3+2*e]=d[e]>>8&255,o[3+2*e+1]=255&d[e];addLog(`å‘é€ ${e} å¹´å‡æœŸæ•°æ® (${d.length} ä¸ª)...`),await write(EpdCmd.SET_HOLIDAYS,o)?(addLog("âœ… å‡æœŸæ•°æ®å·²å‘é€"),n=new Date(e,t-1,1,0,0,0),n=Math.floor(n.getTime()/1e3),addLog(`è®¾ç½®æ—¥æœŸåˆ°: ${e}-${String(t).padStart(2,"0")}-01`),n=new Uint8Array([n>>24&255,n>>16&255,n>>8&255,255&n,-(new Date).getTimezoneOffset()/60,1]),await write(EpdCmd.SET_TIME,n)?(addLog(`âœ… å·²è®¾ç½®åˆ° ${e}å¹´${t}æœˆï¼Œåˆ‡æ¢åˆ°æ—¥å†æ¨¡å¼`),addLog(`ğŸ“… è®¾å¤‡å°†æ˜¾ç¤º ${e}å¹´${t}æœˆçš„æ—¥å†å’Œè°ƒä¼‘ä¿¡æ¯`),addLog("â³ å±å¹•åˆ·æ–°å®Œæˆå‰è¯·ä¸è¦æ“ä½œ"),a.textContent=`âœ… æ˜¾ç¤º ${e}å¹´${t}æœˆæ—¥å†`,0<(n=d.filter(e=>(e>>8&15)===t)).length?(i=n.filter(e=>0==(e>>12&15)).length,n=n.filter(e=>1==(e>>12&15)).length,addLog(`ğŸ“Š ${t}æœˆ: ${i}ä¸ªä¼‘æ¯æ—¥, ${n}ä¸ªè°ƒä¼‘ä¸Šç­æ—¥`)):addLog(`ğŸ“Š ${t}æœˆ: æ— ç‰¹æ®Šå‡æœŸå®‰æ’`)):(a.textContent="âŒ åˆ‡æ¢æ—¥å†å¤±è´¥",addLog("âŒ åˆ‡æ¢åˆ°æ—¥å†æ¨¡å¼å¤±è´¥ï¼"))):(a.textContent="âŒ å‡æœŸæ•°æ®å‘é€å¤±è´¥",addLog("âŒ å‡æœŸæ•°æ®å‘é€å¤±è´¥ï¼"))}else a.textContent=`âŒ æœªæ‰¾åˆ° ${e} å¹´æ•°æ®`,alert(`æ— æ³•åŠ è½½${e}å¹´çš„å‡æœŸæ•°æ®ï¼
è¯·ç¡®è®¤ holiday-cn/${e}.json æ–‡ä»¶å­˜åœ¨ã€‚`)}}