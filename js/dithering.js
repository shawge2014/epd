let rgbPalette=[{name:"黄色",r:255,g:255,b:0,value:226},{name:"绿色",r:41,g:204,b:20,value:150},{name:"蓝色",r:0,g:0,b:255,value:29},{name:"红色",r:255,g:0,b:0,value:76},{name:"黑色",r:0,g:0,b:0,value:0},{name:"白色",r:255,g:255,b:255,value:255}],fourColorPalette=[{name:"黑色",r:0,g:0,b:0,value:0},{name:"白色",r:255,g:255,b:255,value:1},{name:"红色",r:255,g:0,b:0,value:3},{name:"黄色",r:255,g:255,b:0,value:2}],threeColorPalette=[{name:"黑色",r:0,g:0,b:0,value:0},{name:"白色",r:255,g:255,b:255,value:1},{name:"红色",r:255,g:0,b:0,value:2}],epdRealColors={fourColor:[{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:1},{name:"红色",realR:180,realG:50,realB:50,r:255,g:0,b:0,value:3},{name:"黄色",realR:200,realG:195,realB:60,r:255,g:255,b:0,value:2}],threeColor:[{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:1},{name:"红色",realR:180,realG:50,realB:50,r:255,g:0,b:0,value:2}],blackWhite:[{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:1}]};function adjustContrast(e,t){var a=e.data;for(let r=0;r<a.length;r+=4)for(let e=0;e<3;e++){var l=.04045<(l=a[r+e]/255)?Math.pow((.055+l)/1.055,2.4):l/12.92;l=.0031308<(l=Math.min(1,Math.max(0,(l-.5)*t+.5)))?1.055*Math.pow(l,1/2.4)-.055:12.92*l,a[r+e]=Math.min(255,Math.max(0,Math.round(255*l)))}return e}function rgbToLab(e,r,t){r/=255,t/=255,e=.04045<(e/=255)?Math.pow((e+.055)/1.055,2.4):e/12.92,r=.04045<r?Math.pow((r+.055)/1.055,2.4):r/12.92,t=.04045<t?Math.pow((t+.055)/1.055,2.4):t/12.92;var a=.4124*(e*=100)+.3576*(r*=100)+.1805*(t*=100),l=.2126*e+.7152*r+.0722*t,e=.0193*e+.1192*r+.9505*t;return l/=100,e/=108.883,a=.008856<(a/=95.047)?Math.pow(a,1/3):7.787*a+16/116,{l:116*(l=.008856<l?Math.pow(l,1/3):7.787*l+16/116)-16,a:500*(a-l),b:200*(l-(.008856<e?Math.pow(e,1/3):7.787*e+16/116))}}function boostSaturation(e,l){if(!(l<=1)){var o=e.data;for(let e=0;e<o.length;e+=4){let r=o[e]/255,t=o[e+1]/255,a=o[e+2]/255;var n=Math.max(r,t,a),i=Math.min(r,t,a),h=(n+i)/2;if(n!==i){var u=n-i,i=.5<h?u/(2-n-i):u/(n+i);let e;e=n===r?((t-a)/u+(t<a?6:0))/6:n===t?((a-r)/u+2)/6:((r-t)/u+4)/6;i=Math.min(1,i*l),n=(e,r,t)=>(t<0&&(t+=1),1<t&&--t,t<1/6?e+6*(r-e)*t:t<.5?r:t<2/3?e+(r-e)*(2/3-t)*6:e),u=h<.5?h*(1+i):h+i-h*i,i=2*h-u;r=n(i,u,e+1/3),t=n(i,u,e),a=n(i,u,e-1/3)}o[e]=Math.round(255*r),o[e+1]=Math.round(255*t),o[e+2]=Math.round(255*a)}}return e}function ciede2000(e,r){var t=e.l,a=e.a,e=e.b,l=r.l,o=r.a,r=r.b,n=Math.sqrt(a*a+e*e),i=Math.sqrt(o*o+r*r),n=Math.pow((n+i)/2,7),i=.5*(1-Math.sqrt(n/(n+6103515625))),n=a*(1+i),a=o*(1+i),o=Math.sqrt(n*n+e*e),i=Math.sqrt(a*a+r*r);let h=180*Math.atan2(e,n)/Math.PI,u=(h<0&&(h+=360),180*Math.atan2(r,a)/Math.PI);u<0&&(u+=360);e=l-t,n=i-o;let f;f=o*i==0?0:Math.abs(u-h)<=180?u-h:180<u-h?u-h-360:u-h+360;r=2*Math.sqrt(o*i)*Math.sin(f*Math.PI/360),a=(t+l)/2,t=(o+i)/2;let b;b=o*i==0?h+u:Math.abs(h-u)<=180?(h+u)/2:h+u<360?(h+u+360)/2:(h+u-360)/2;l=1-.17*Math.cos((b-30)*Math.PI/180)+.24*Math.cos(2*b*Math.PI/180)+.32*Math.cos((3*b+6)*Math.PI/180)-.2*Math.cos((4*b-63)*Math.PI/180),o=(a-50)*(a-50),i=1+.015*o/Math.sqrt(20+o),a=1+.045*t,o=1+.015*t*l,l=Math.pow(t,7),t=e/i,e=n/a,i=r/o;return t*t+e*e+i*i+-2*Math.sqrt(l/(l+6103515625))*Math.sin(60*Math.exp(-(b-275)/25*((b-275)/25))*Math.PI/180)*e*i}function initPaletteLab(e,r){return e.map(e=>({...e,lab:r&&void 0!==e.realR?rgbToLab(e.realR,e.realG,e.realB):rgbToLab(e.r,e.g,e.b)}))}let rgbPaletteWithLab=initPaletteLab(rgbPalette,!1),fourColorPaletteWithLab=initPaletteLab(fourColorPalette,!1),threeColorPaletteWithLab=initPaletteLab(threeColorPalette,!1),epdFourColorWithLab=initPaletteLab(epdRealColors.fourColor,!0),epdThreeColorWithLab=initPaletteLab(epdRealColors.threeColor,!0),epdBWWithLab=initPaletteLab(epdRealColors.blackWhite,!0);function labDistanceFn(e,r,t){return"blackWhiteColor"===t?(t=e.l-r.l)*t:ciede2000(e,r)}function findClosestColor(e,r,t,a){if("threeColor"===a)return 120<e&&1.5*r<e&&1.5*t<e?threeColorPalette[2]:.299*e+.587*r+.114*t<128?threeColorPalette[0]:threeColorPalette[1];if("blackWhiteColor"===a)return.299*Math.min(255,Math.max(0,e))+.587*Math.min(255,Math.max(0,r))+.114*Math.min(255,Math.max(0,t))<128?{r:0,g:0,b:0,value:0}:{r:255,g:255,b:255,value:1};let l;if("fourColor"===a)l=epdFourColorWithLab;else{if(e<50&&r<150&&100<t)return rgbPalette[2];l=rgbPaletteWithLab}var o,n=rgbToLab(Math.min(255,Math.max(0,e)),Math.min(255,Math.max(0,r)),Math.min(255,Math.max(0,t)));let i=1/0,h=l[0];for(o of l){var u=labDistanceFn(n,o.lab,a);u<i&&(i=u,h=o)}return h}function computeEdgeMap(e){var t=e.width,a=e.height,r=e.data,l=new Float32Array(t*a);for(let e=0;e<t*a;e++){var o=4*e;l[e]=.299*r[o]+.587*r[1+o]+.114*r[2+o]}var n=new Float32Array(t*a);let i=0;for(let r=1;r<a-1;r++)for(let e=1;e<t-1;e++){var h=r*t+e,u=-l[h-t-1]+l[h-t+1]-2*l[h-1]+2*l[h+1]-l[h+t-1]+l[h+t+1],f=-l[h-t-1]-2*l[h-t]-l[h-t+1]+l[h+t-1]+2*l[h+t]+l[h+t+1],u=Math.sqrt(u*u+f*f);(n[h]=u)>i&&(i=u)}if(0<i){var b=1/i;for(let e=0;e<n.length;e++)n[e]*=b}return n}let FLOYD_STEINBERG_KERNEL=[[1,0,7/16],[-1,1,3/16],[0,1,5/16],[1,1,1/16]],ATKINSON_KERNEL=[[1,0,1/8],[2,0,1/8],[-1,1,1/8],[0,1,1/8],[1,1,1/8],[0,2,1/8]],STUCKI_KERNEL=[[1,0,8/42],[2,0,4/42],[-2,1,2/42],[-1,1,4/42],[0,1,8/42],[1,1,4/42],[2,1,2/42],[-2,2,1/42],[-1,2,2/42],[0,2,4/42],[1,2,2/42],[2,2,1/42]],JARVIS_KERNEL=[[1,0,7/48],[2,0,5/48],[-2,1,3/48],[-1,1,5/48],[0,1,7/48],[1,1,5/48],[2,1,3/48],[-2,2,1/48],[-1,2,3/48],[0,2,5/48],[1,2,3/48],[2,2,1/48]];function errorDiffusionDither(e,a,l,o){var n=e.width,i=e.height,h=e.data,r=n*i,u=computeEdgeMap(e),f=new Float32Array(r),b=new Float32Array(r),s=new Float32Array(r);for(let e=0;e<r;e++){var t=4*e;f[e]=h[t],b[e]=h[1+t],s[e]=h[2+t]}var v=o.length;for(let t=0;t<i;t++){var M=1&t,g=M?-1:n,m=M?-1:1;for(let r=M?n-1:0;r!==g;r+=m){var c=t*n+r,d=f[c],C=b[c],w=s[c],p=findClosestColor(d,C,w,l),y=4*c,y=(h[y]=p.r,h[1+y]=p.g,h[2+y]=p.b,u[c]);let e=1;var c=a*(e=.3<y?.15+.85*(1-(y-.3)/.7):e),P=(d-p.r)*c,D=(C-p.g)*c,L=(w-p.b)*c;for(let e=0;e<v;e++){var A=r+(M?-o[e][0]:o[e][0]),R=t+o[e][1];0<=A&&A<n&&0<=R&&R<i&&(R=R*n+A,A=o[e][2],f[R]+=P*A,b[R]+=D*A,s[R]+=L*A)}}}return e}function floydSteinbergDither(e,r,t){return errorDiffusionDither(e,r,t,FLOYD_STEINBERG_KERNEL)}function atkinsonDither(e,r,t){return errorDiffusionDither(e,r,t,ATKINSON_KERNEL)}function stuckiDither(e,r,t){return errorDiffusionDither(e,r,t,STUCKI_KERNEL)}function jarvisDither(e,r,t){return errorDiffusionDither(e,r,t,JARVIS_KERNEL)}function bayerDither(e,t,a){var l=e.width,o=e.height,n=e.data,i=[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]];for(let r=0;r<o;r++)for(let e=0;e<l;e++){var h=4*(r*l+e),u=(i[7&r][7&e]/64*255-127.5)*t,u=findClosestColor(Math.min(255,Math.max(0,n[h]+u)),Math.min(255,Math.max(0,n[1+h]+u)),Math.min(255,Math.max(0,n[2+h]+u)),a);n[h]=u.r,n[1+h]=u.g,n[2+h]=u.b}return e}let _blueNoiseSize=64,_blueNoiseTile=null;function generateBlueNoiseTile(){if(_blueNoiseTile)return _blueNoiseTile;let i=_blueNoiseSize,h=i*i;var r=new Float32Array(h),t=new Uint8Array(h),a=Math.round(.1*h),l=[];for(let e=0;e<h;e++)l.push(e);let o=12345;for(let e=h-1;0<e;e--){var n=Math.floor((o=(16807*o+0)%2147483647)/2147483647*(e+1));[l[e],l[n]]=[l[n],l[e]]}for(let e=0;e<a;e++)t[l[e]]=1;let u=[];for(let r=-8;r<=8;r++)for(let e=-8;e<=8;e++){var f=e*e+r*r;f<=64&&u.push({dx:e,dy:r,w:Math.exp(-f/4.5)})}function b(r){var t=new Float32Array(h);for(let e=0;e<h;e++)if(r[e]){var a,l=e/i|0,o=e%i;for(a of u){var n=(o+a.dx+i)%i;t[(l+a.dy+i)%i*i+n]+=a.w}}return t}let s=new Uint8Array(t),v=a-1;var M=new Int32Array(h).fill(-1);for(let e=a;0<e;e--){var g=b(s);let r=-1,t=0;for(let e=0;e<h;e++)s[e]&&g[e]>r&&(r=g[e],t=e);M[t]=v--,s[t]=0}s=new Uint8Array(t);for(let e=v=a;e<h;e++){var m=b(s);let r=1/0,t=0;for(let e=0;e<h;e++)!s[e]&&m[e]<r&&(r=m[e],t=e);M[t]=v++,s[t]=1}var c=1/(h-1);for(let e=0;e<h;e++)r[e]=M[e]*c;return _blueNoiseTile=r}function blueNoiseDither(e,t,a){var l=e.width,o=e.height,n=e.data,i=generateBlueNoiseTile(),h=_blueNoiseSize;for(let r=0;r<o;r++)for(let e=0;e<l;e++){var u=4*(r*l+e),f=(255*i[r%h*h+e%h]-127.5)*t,f=findClosestColor(Math.min(255,Math.max(0,n[u]+f)),Math.min(255,Math.max(0,n[1+u]+f)),Math.min(255,Math.max(0,n[2+u]+f)),a);n[u]=f.r,n[1+u]=f.g,n[2+u]=f.b}return e}function hilbertCurve(r){var t=[];var a=r*r;for(let e=0;e<a;e++)t.push(((e,r)=>{let t,a,l,o=0,n=0;for(l=1;l<e;l*=2)0==(a=1&(r^(t=1&(r/2|0))))&&(1==t&&(o=l-1-o,n=l-1-n),[o,n]=[n,o]),o+=l*t,n+=l*a,r=r/4|0;return[o,n]})(r,e));return t}function riemersmaDither(e,l,o){var r=e.width,t=e.height,n=e.data,a=r*t,i=Math.max(r,t);let h=2;for(;h<i;)h*=2;var u,f,b=[];for([u,f]of hilbertCurve(h))u<r&&f<t&&b.push(f*r+u);var s=new Float32Array(a),v=new Float32Array(a),M=new Float32Array(a);for(let e=0;e<a;e++){var g=4*e;s[e]=n[g],v[e]=n[1+g],M[e]=n[2+g]}var m=1/Math.exp(1),c=new Float32Array(16);let d=0;for(let e=0;e<16;e++)c[e]=Math.pow(m,e),d+=c[e];for(let e=0;e<16;e++)c[e]/=d;var C=new Float32Array(16),w=new Float32Array(16),p=new Float32Array(16);let y=0;for(let e=0;e<b.length;e++){var P=b[e];let r=0,t=0,a=0;for(let e=0;e<16;e++){var D=(y+e)%16;r+=C[D]*c[e],t+=w[D]*c[e],a+=p[D]*c[e]}var L=s[P]+r,A=v[P]+t,R=M[P]+a,N=findClosestColor(L,A,R,o),P=4*P,P=(n[P]=N.r,n[1+P]=N.g,n[2+P]=N.b,(L-N.r)*l),L=(A-N.g)*l,A=(R-N.b)*l;C[y=(y+16-1)%16]=P,w[y]=L,p[y]=A}return e}function ditherImage(e,r,t,a){switch("fourColor"===a||"sixColor"===a?boostSaturation(e,1.3):"threeColor"===a&&boostSaturation(e,1.15),r){case"floydSteinberg":return floydSteinbergDither(e,t,a);case"atkinson":return atkinsonDither(e,t,a);case"stucki":return stuckiDither(e,t,a);case"jarvis":return jarvisDither(e,t,a);case"bayer":return bayerDither(e,t,a);case"blueNoise":return blueNoiseDither(e,t,a);case"riemersma":return riemersmaDither(e,t,a);default:return e}}function decodeProcessedData(a,l,o,e){var r=new ImageData(l,o),n=r.data;if("sixColor"===e)for(let t=0;t<o;t++)for(let e=0;e<l;e++){let r=a[e*o+(o-1-t)];var i=rgbPalette.find(e=>e.value===r)||rgbPalette[5],h=4*(t*l+e);n[h]=i.r,n[1+h]=i.g,n[2+h]=i.b,n[3+h]=255}else if("fourColor"===e){var u=[{value:0,r:0,g:0,b:0},{value:1,r:255,g:255,b:255},{value:3,r:255,g:0,b:0},{value:2,r:255,g:255,b:0}];for(let t=0;t<o;t++)for(let e=0;e<l;e++){var f=(t*l+e)/4|0,b=6-e%4*2;let r=a[f]>>b&3;f=u.find(e=>e.value===r)||u[1],b=4*(t*l+e);n[b]=f.r,n[1+b]=f.g,n[2+b]=f.b,n[3+b]=255}}else if("blackWhiteColor"===e){var t=Math.ceil(l/8);for(let r=0;r<o;r++)for(let e=0;e<l;e++){var s=r*t+Math.floor(e/8),v=7-e%8,s=a[s]>>v&1,v=4*(r*l+e);n[v]=s?255:0,n[1+v]=s?255:0,n[2+v]=s?255:0,n[3+v]=255}}else if("threeColor"===e){var M=Math.ceil(l/8),g=a.slice(0,M*o),m=a.slice(M*o);for(let r=0;r<o;r++)for(let e=0;e<l;e++){var c=r*M+Math.floor(e/8),d=7-e%8,C=g[c]>>d&1,c=m[c]>>d&1,d=4*(r*l+e);c?(n[d]=C?255:0,n[1+d]=C?255:0,n[2+d]=C?255:0):(n[d]=255,n[1+d]=0,n[2+d]=0),n[3+d]=255}}return r}function processImageData(e,t){var a=e.width,l=e.height,o=e.data;let n;if("sixColor"===t){n=new Uint8Array(a*l);for(let r=0;r<l;r++)for(let e=0;e<a;e++){var i=4*(r*a+e),i=findClosestColor(o[i],o[1+i],o[2+i],t),h=e*l+(l-1-r);n[h]=i.value}}else if("fourColor"===t){n=new Uint8Array(Math.ceil(a*l/4));for(let r=0;r<l;r++)for(let e=0;e<a;e++){var u=4*(r*a+e),u=findClosestColor(o[u],o[1+u],o[2+u],t).value,f=(r*a+e)/4|0,b=6-e%4*2;n[f]|=u<<b}}else if("blackWhiteColor"===t){var s=Math.ceil(a/8);n=new Uint8Array(s*l);for(let r=0;r<l;r++)for(let e=0;e<a;e++){var v=4*(r*a+e),M=o[v],g=o[1+v],v=o[2+v],M=140<=Math.round(.299*M+.587*g+.114*v)?1:0,g=r*s+Math.floor(e/8),v=7-e%8;n[g]|=M<<v}}else if("threeColor"===t){var m=Math.ceil(a/8),c=new Uint8Array(l*m),d=new Uint8Array(l*m);for(let r=0;r<l;r++)for(let e=0;e<a;e++){var C=4*(r*a+e),w=o[C],p=o[1+C],C=o[2+C],y=140<=Math.round(.299*w+.587*p+.114*C)?1:0,P=r*m+Math.floor(e/8),D=7-e%8,y=(y?c[P]|=1<<D:c[P]&=~(1<<D),160<w&&p<w&&C<w?0:1),P=r*m+Math.floor(e/8),D=7-e%8;y?d[P]|=1<<D:d[P]&=~(1<<D)}(n=new Uint8Array(c.length+d.length)).set(c,0),n.set(d,c.length)}return n}