let rgbPalette=[{name:"黄色",r:255,g:255,b:0,value:226},{name:"绿色",r:41,g:204,b:20,value:150},{name:"蓝色",r:0,g:0,b:255,value:29},{name:"红色",r:255,g:0,b:0,value:76},{name:"黑色",r:0,g:0,b:0,value:0},{name:"白色",r:255,g:255,b:255,value:255}],fourColorPalette=[{name:"黑色",r:0,g:0,b:0,value:0},{name:"白色",r:255,g:255,b:255,value:1},{name:"红色",r:255,g:0,b:0,value:3},{name:"黄色",r:255,g:255,b:0,value:2}],threeColorPalette=[{name:"黑色",r:0,g:0,b:0,value:0},{name:"白色",r:255,g:255,b:255,value:1},{name:"红色",r:255,g:0,b:0,value:2}],epdRealColors={sixColor:[{name:"黄色",realR:200,realG:195,realB:60,r:255,g:255,b:0,value:226},{name:"绿色",realR:35,realG:140,realB:35,r:41,g:204,b:20,value:150},{name:"蓝色",realR:30,realG:40,realB:140,r:0,g:0,b:255,value:29},{name:"红色",realR:180,realG:50,realB:50,r:255,g:0,b:0,value:76},{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:255}],fourColor:[{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:1},{name:"红色",realR:180,realG:50,realB:50,r:255,g:0,b:0,value:3},{name:"黄色",realR:200,realG:195,realB:60,r:255,g:255,b:0,value:2}],threeColor:[{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:1},{name:"红色",realR:180,realG:50,realB:50,r:255,g:0,b:0,value:2}],blackWhite:[{name:"黑色",realR:30,realG:30,realB:30,r:0,g:0,b:0,value:0},{name:"白色",realR:220,realG:215,realB:205,r:255,g:255,b:255,value:1}]};function adjustContrast(a,r){var e=new Uint8Array(256);for(let a=0;a<256;a++){var t=.04045<(t=a/255)?Math.pow((.055+t)/1.055,2.4):t/12.92;t=.0031308<(t=Math.min(1,Math.max(0,(t-.5)*r+.5)))?1.055*Math.pow(t,1/2.4)-.055:12.92*t,e[a]=Math.min(255,Math.max(0,Math.round(255*t)))}var o=a.data;for(let a=0;a<o.length;a+=4)o[a]=e[o[a]],o[a+1]=e[o[a+1]],o[a+2]=e[o[a+2]];return a}let _srgbToLinear=new Float32Array(256),_linearToSrgb=new Uint8Array(4096);for(let r=0;r<256;r++){let a=r/255;_srgbToLinear[r]=.04045<a?Math.pow((a+.055)/1.055,2.4):a/12.92}for(let r=0;r<4096;r++){let a=r/4095;_linearToSrgb[r]=Math.min(255,Math.max(0,Math.round(255*(.0031308<a?1.055*Math.pow(a,1/2.4)-.055:12.92*a))))}function unsharpMask(r,e,t){if(!(e<=0)){var i=r.width,h=r.height,o=r.data,l=i*h,M=new Float32Array(l);for(let a=0;a<l;a++){var n=4*a;M[a]=.2126*_srgbToLinear[o[n]]+.7152*_srgbToLinear[o[1+n]]+.0722*_srgbToLinear[o[2+n]]}var b=new Float32Array(M),f=new Float32Array(l),m=Math.max(1,Math.round(t));for(let a=0;a<3;a++){for(let o=0;o<h;o++)for(let t=0;t<i;t++){let r=0,e=0;for(let a=-m;a<=m;a++){var s=t+a;0<=s&&s<i&&(r+=b[o*i+s],e++)}f[o*i+t]=r/e}for(let o=0;o<h;o++)for(let t=0;t<i;t++){let r=0,e=0;for(let a=-m;a<=m;a++){var u=o+a;0<=u&&u<h&&(r+=f[u*i+t],e++)}b[o*i+t]=r/e}}var g=new Float32Array(l);let a=0;for(let n=0;n<h;n++)for(let l=0;l<i;l++){var v=n*i+l;let e=0,t=0,o=0;for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){var _=n+r,T=l+a;0<=_&&_<h&&0<=T&&T<i&&(_=M[_*i+T],e+=_,t+=_*_,o++)}var d=e/o,d=t/o-d*d;(g[v]=d)>a&&(a=d)}if(0<a){var L=1/a;for(let a=0;a<l;a++){var c=g[a]*L;g[a]=Math.min(1,Math.max(0,(c-.05)/.15))}}for(let a=0;a<l;a++){var x=(M[a]-b[a])*e*g[a],C=4*a,w=_srgbToLinear[o[C]]+x,p=_srgbToLinear[o[1+C]]+x,x=_srgbToLinear[o[2+C]]+x;o[C]=_linearToSrgb[Math.min(4095,Math.max(0,4095*w+.5|0))],o[1+C]=_linearToSrgb[Math.min(4095,Math.max(0,4095*p+.5|0))],o[2+C]=_linearToSrgb[Math.min(4095,Math.max(0,4095*x+.5|0))]}}return r}function analyzeImage(a){var r=a.data,a=r.length/4;if(0==a)return{meanY:.5,stdY:.2,meanSat:.3,dynamicRange:1};let e=0,t=0,o=0;var l=new Uint32Array(256);for(let a=0;a<r.length;a+=4){var n=.2126*_srgbToLinear[r[a]]+.7152*_srgbToLinear[r[a+1]]+.0722*_srgbToLinear[r[a+2]],n=(e+=n,t+=n*n,_linearToSrgb[Math.min(4095,Math.max(0,4095*n+.5|0))]),n=(l[n]++,Math.max(r[a],r[a+1],r[a+2])),i=Math.min(r[a],r[a+1],r[a+2]);0<n&&(o+=(n-i)/n)}var h=e/a,M=Math.sqrt(Math.max(0,t/a-h*h)),b=o/a,f=Math.floor(.02*a);let m=0,s=0;for(let a=0;a<256;a++)if((m+=l[a])>=f){s=a;break}m=0;let u=255;for(let a=255;0<=a;a--)if((m+=l[a])>=f){u=a;break}return{meanY:h,stdY:M,meanSat:b,dynamicRange:Math.max(.01,(u-s)/255)}}function adaptiveGammaCorrection(a){var i=a.data,h=i.length/4;if(0!=h){var M=new Uint32Array(256);let r=0;for(let a=0;a<i.length;a+=4){var b=.2126*_srgbToLinear[i[a]]+.7152*_srgbToLinear[i[a+1]]+.0722*_srgbToLinear[i[a+2]],b=(r+=b,_linearToSrgb[Math.min(4095,Math.max(0,4095*b+.5|0))]);M[b]++}var f=Math.floor(.005*h);let e=0,t=0;for(let a=0;a<256;a++)if((e+=M[a])>=f){t=a;break}let o=0,l=255;for(let a=255;0<=a;a--)if((o+=M[a])>=f){l=a;break}var m=l-t,s=20<=m,h=r/h,h=_linearToSrgb[Math.min(4095,Math.max(0,4095*h+.5|0))];let n=1;1<h&&h<254&&(h=Math.log(.5)/Math.log(h/255),n=Math.min(1.8,Math.max(.5,h)));var u=new Uint8Array(256);for(let r=0;r<256;r++){let a=r;s&&(a=Math.min(255,Math.max(0,Math.round((r-t)/m*255)))),u[r]=Math.round(255*Math.pow(a/255,n))}for(let a=0;a<i.length;a+=4)i[a]=u[i[a]],i[a+1]=u[i[a+1]],i[a+2]=u[i[a+2]]}return a}function boostSaturation(a,o){if(!(o<=1)){var l=a.data;for(let a=0;a<l.length;a+=4){let r=l[a]/255,e=l[a+1]/255,t=l[a+2]/255;var n=Math.max(r,e,t),i=Math.min(r,e,t),h=(n+i)/2;if(n!==i){var M=n-i,i=.5<h?M/(2-n-i):M/(n+i);let a;a=n===r?((e-t)/M+(e<t?6:0))/6:n===e?((t-r)/M+2)/6:((r-e)/M+4)/6;i=Math.min(1,i*o),n=(a,r,e)=>(e<0&&(e+=1),1<e&&--e,e<1/6?a+6*(r-a)*e:e<.5?r:e<2/3?a+(r-a)*(2/3-e)*6:a),M=h<.5?h*(1+i):h+i-h*i,i=2*h-M;r=n(i,M,a+1/3),e=n(i,M,a),t=n(i,M,a-1/3)}l[a]=Math.round(255*r),l[a+1]=Math.round(255*e),l[a+2]=Math.round(255*t)}}return a}function claheEnhance(a,o,e){var l=a.width,n=a.height,t=a.data;if(!(l<4*e||n<4*e)){var r=l*n,i=new Uint8Array(r);for(let a=0;a<r;a++){var h=4*a;i[a]=Math.round(.299*t[h]+.587*t[1+h]+.114*t[2+h])}var M=Math.ceil(l/e),b=Math.ceil(n/e),f=[];for(let t=0;t<e;t++){f[t]=[];for(let a=0;a<e;a++){var m=a*M,s=t*b,u=Math.min(l,m+M),g=Math.min(n,s+b),v=(u-m)*(g-s);if(0==v)f[t][a]=new Uint8Array(256).fill(0).map((a,r)=>r);else{var _=new Uint32Array(256);for(let r=s;r<g;r++)for(let a=m;a<u;a++)_[i[r*l+a]]++;var T=Math.max(1,Math.floor(o*v/256));let r=0;for(let a=0;a<256;a++)_[a]>T&&(r+=_[a]-T,_[a]=T);var d=Math.floor(r/256),L=r-256*d;for(let a=0;a<256;a++)_[a]+=d+(a<L?1:0);var c=new Uint8Array(256);let e=0;var x=Math.max(1,v-1);for(let a=0;a<256;a++)e+=_[a],c[a]=Math.min(255,Math.round((e-1)/x*255));f[t][a]=c}}}for(let r=0;r<n;r++)for(let a=0;a<l;a++){var C=(a+.5)/M-.5,w=(r+.5)/b-.5,p=Math.max(0,Math.floor(C)),S=Math.max(0,Math.floor(w)),y=Math.min(e-1,p+1),E=Math.min(e-1,S+1),C=Math.max(0,Math.min(1,C-p)),w=Math.max(0,Math.min(1,w-S)),A=i[r*l+a],S=f[S][p][A]*(1-C)*(1-w)+f[S][y][A]*C*(1-w)+f[E][p][A]*(1-C)*w+f[E][y][A]*C*w,p=i[r*l+a],E=4*(r*l+a);if(p<8){y=Math.max(0,S-p);t[E]=Math.min(255,t[E]+y),t[1+E]=Math.min(255,t[1+E]+y),t[2+E]=Math.min(255,t[2+E]+y)}else{A=Math.min(2.5,S/p);let a=t[E]*A,r=t[1+E]*A,e=t[2+E]*A;C=Math.max(a,r,e);255<C&&(w=(C-255)/(C-S+.001),a+=w*(S-a),r+=w*(S-r),e+=w*(S-e)),t[E]=Math.min(255,Math.max(0,Math.round(a))),t[1+E]=Math.min(255,Math.max(0,Math.round(r))),t[2+E]=Math.min(255,Math.max(0,Math.round(e)))}}}return a}function rgbToLab(a,r,e){r/=255,e/=255,a=.04045<(a/=255)?Math.pow((a+.055)/1.055,2.4):a/12.92,r=.04045<r?Math.pow((r+.055)/1.055,2.4):r/12.92,e=.04045<e?Math.pow((e+.055)/1.055,2.4):e/12.92;var t=.4124*(a*=100)+.3576*(r*=100)+.1805*(e*=100),o=.2126*a+.7152*r+.0722*e,a=.0193*a+.1192*r+.9505*e;return o/=100,a/=108.883,t=.008856<(t/=95.047)?Math.pow(t,1/3):7.787*t+16/116,{l:116*(o=.008856<o?Math.pow(o,1/3):7.787*o+16/116)-16,a:500*(t-o),b:200*(o-(.008856<a?Math.pow(a,1/3):7.787*a+16/116))}}function ciede2000(a,r){var e=a.l,t=a.a,a=a.b,o=r.l,l=r.a,r=r.b,n=Math.sqrt(t*t+a*a),i=Math.sqrt(l*l+r*r),n=Math.pow((n+i)/2,7),i=.5*(1-Math.sqrt(n/(n+6103515625))),n=t*(1+i),t=l*(1+i),l=Math.sqrt(n*n+a*a),i=Math.sqrt(t*t+r*r);let h=180*Math.atan2(a,n)/Math.PI,M=(h<0&&(h+=360),180*Math.atan2(r,t)/Math.PI);M<0&&(M+=360);a=o-e,n=i-l;let b;b=l*i==0?0:Math.abs(M-h)<=180?M-h:180<M-h?M-h-360:M-h+360;r=2*Math.sqrt(l*i)*Math.sin(b*Math.PI/360),t=(e+o)/2,e=(l+i)/2;let f;f=l*i==0?h+M:Math.abs(h-M)<=180?(h+M)/2:h+M<360?(h+M+360)/2:(h+M-360)/2;o=1-.17*Math.cos((f-30)*Math.PI/180)+.24*Math.cos(2*f*Math.PI/180)+.32*Math.cos((3*f+6)*Math.PI/180)-.2*Math.cos((4*f-63)*Math.PI/180),l=(t-50)*(t-50),i=1+.015*l/Math.sqrt(20+l),t=1+.045*e,l=1+.015*e*o,o=Math.pow(e,7),e=a/(.7*i),a=n/t,i=r/l;return e*e+a*a+i*i+-2*Math.sqrt(o/(o+6103515625))*Math.sin(60*Math.exp(-(f-275)/25*((f-275)/25))*Math.PI/180)*a*i}function initPaletteLab(a,r){return a.map(a=>({...a,lab:r&&void 0!==a.realR?rgbToLab(a.realR,a.realG,a.realB):rgbToLab(a.r,a.g,a.b)}))}let rgbPaletteWithLab=initPaletteLab(rgbPalette,!1),fourColorPaletteWithLab=initPaletteLab(fourColorPalette,!1),threeColorPaletteWithLab=initPaletteLab(threeColorPalette,!1),epdFourColorWithLab=initPaletteLab(epdRealColors.fourColor,!0),epdThreeColorWithLab=initPaletteLab(epdRealColors.threeColor,!0),epdBWWithLab=initPaletteLab(epdRealColors.blackWhite,!0),epdSixColorWithLab=initPaletteLab(epdRealColors.sixColor,!0),_epdBWThreshold=(()=>{var a=epdBWWithLab[0].lab,r=epdBWWithLab[1].lab,a=(16+(a.l+r.l)/2)/116,r=6/29<a?a*a*a:6/29*3*(6/29)*(a-4/29),a=.0031308<r?1.055*Math.pow(r,1/2.4)-.055:12.92*r;return Math.round(255*a)})(),_LUT_BITS=5,_LUT_SIZE=1<<_LUT_BITS,_LUT_STEP=256/_LUT_SIZE,_colorLUTs={};function _findClosestColorDirect(a,r,e,t){if("blackWhiteColor"===t)return.299*a+.587*r+.114*e<_epdBWThreshold?{r:0,g:0,b:0,value:0}:{r:255,g:255,b:255,value:1};let o;o="threeColor"===t?epdThreeColorWithLab:"fourColor"===t?epdFourColorWithLab:epdSixColorWithLab;var l,n=rgbToLab(a,r,e);let i=1/0,h=o[0];for(l of o){var M=ciede2000(n,l.lab);M<i&&(i=M,h=l)}return h}function _buildColorLUT(e){var t=_LUT_SIZE,o=_LUT_STEP,l=new Array(t*t*t);for(let r=0;r<t;r++){var n=Math.min(255,r*o+(o>>1));for(let a=0;a<t;a++){var i=Math.min(255,a*o+(o>>1)),h=(r*t+a)*t;for(let a=0;a<t;a++){var M=Math.min(255,a*o+(o>>1));l[h+a]=_findClosestColorDirect(n,i,M,e)}}}return l}function _getColorLUT(a){return _colorLUTs[a]||(_colorLUTs[a]=_buildColorLUT(a)),_colorLUTs[a]}function findClosestColor(a,r,e,t){var o,l;return"blackWhiteColor"===t?.299*Math.min(255,Math.max(0,a))+.587*Math.min(255,Math.max(0,r))+.114*Math.min(255,Math.max(0,e))<_epdBWThreshold?{r:0,g:0,b:0,value:0}:{r:255,g:255,b:255,value:1}:(t=_getColorLUT(t),o=_LUT_SIZE,l=8-_LUT_BITS,t[(Math.min(o-1,Math.max(0,Math.min(255,Math.max(0,a))>>l))*o+Math.min(o-1,Math.max(0,Math.min(255,Math.max(0,r))>>l)))*o+Math.min(o-1,Math.max(0,Math.min(255,Math.max(0,e))>>l))])}function computeEdgeMap(a){var e=a.width,t=a.height,r=a.data,o=new Float32Array(e*t);for(let a=0;a<e*t;a++){var l=4*a;o[a]=.2126*_srgbToLinear[r[l]]+.7152*_srgbToLinear[r[1+l]]+.0722*_srgbToLinear[r[2+l]]}var n=new Float32Array(e*t);let i=0;for(let r=1;r<t-1;r++)for(let a=1;a<e-1;a++){var h=r*e+a,M=-o[h-e-1]+o[h-e+1]-2*o[h-1]+2*o[h+1]-o[h+e-1]+o[h+e+1],b=-o[h-e-1]-2*o[h-e]-o[h-e+1]+o[h+e-1]+2*o[h+e]+o[h+e+1],M=Math.sqrt(M*M+b*b);(n[h]=M)>i&&(i=M)}if(0<i){var f=1/i;for(let a=0;a<n.length;a++)n[a]*=f}return n}function otsuEdgeThreshold(r){var e=new Uint32Array(256);let t=0;for(let a=0;a<r.length;a++).001<r[a]&&(e[Math.min(255,256*r[a]|0)]++,t++);if(t<100)return.3;let o=0;for(let a=0;a<256;a++)o+=a*e[a];let l=0,n=0,i=0,h=0;for(let a=0;a<256;a++)if(0!==(n+=e[a])){var M=t-n;if(0==M)break;var b=(l+=a*e[a])/n-(o-l)/M,M=n*M*b*b;M>i&&(i=M,h=a)}return Math.max(.1,Math.min(.6,(h+.5)/256))}let FLOYD_STEINBERG_KERNEL=[[1,0,7/16],[-1,1,3/16],[0,1,5/16],[1,1,1/16]],ATKINSON_KERNEL=[[1,0,1/8],[2,0,1/8],[-1,1,1/8],[0,1,1/8],[1,1,1/8],[0,2,1/8]],STUCKI_KERNEL=[[1,0,8/42],[2,0,4/42],[-2,1,2/42],[-1,1,4/42],[0,1,8/42],[1,1,4/42],[2,1,2/42],[-2,2,1/42],[-1,2,2/42],[0,2,4/42],[1,2,2/42],[2,2,1/42]],JARVIS_KERNEL=[[1,0,7/48],[2,0,5/48],[-2,1,3/48],[-1,1,5/48],[0,1,7/48],[1,1,5/48],[2,1,3/48],[-2,2,1/48],[-1,2,3/48],[0,2,5/48],[1,2,3/48],[2,2,1/48]];function errorDiffusionDither(a,n,i,h){var M=a.width,b=a.height,f=a.data,r=M*b,m=computeEdgeMap(a),s=otsuEdgeThreshold(m),u=new Float32Array(r),g=new Float32Array(r),v=new Float32Array(r);for(let a=0;a<r;a++){var e=4*a;u[a]=_srgbToLinear[f[e]],g[a]=_srgbToLinear[f[1+e]],v[a]=_srgbToLinear[f[2+e]]}var _=h.length;for(let l=0;l<b;l++){var T=1&l,t=T?-1:M,d=T?-1:1;for(let o=T?M-1:0;o!==t;o+=d){var L=l*M+o,c=findClosestColor(_linearToSrgb[Math.min(4095,Math.max(0,4095*u[L]+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*g[L]+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*v[L]+.5|0))],i),x=4*L,x=(f[x]=c.r,f[1+x]=c.g,f[2+x]=c.b,m[L]);let a=1;x=n*(a=s<x?.15+.85*(1-(x-s)/(1-s)):a);let r=(u[L]-_srgbToLinear[c.r])*x,e=(g[L]-_srgbToLinear[c.g])*x,t=(v[L]-_srgbToLinear[c.b])*x;c=.2126*u[L]+.7152*g[L]+.0722*v[L],x=.3+.4*(1-4*(Math.max(0,Math.min(1,c))-.5)*(Math.max(0,Math.min(1,c))-.5));Math.abs(r)>x&&(r=x*Math.tanh(r/x)),Math.abs(e)>x&&(e=x*Math.tanh(e/x)),Math.abs(t)>x&&(t=x*Math.tanh(t/x));for(let a=0;a<_;a++){var C=o+(T?-h[a][0]:h[a][0]),w=l+h[a][1];0<=C&&C<M&&0<=w&&w<b&&(w=w*M+C,C=h[a][2],u[w]+=r*C,g[w]+=e*C,v[w]+=t*C)}}}return a}function floydSteinbergDither(a,r,e){return errorDiffusionDither(a,r,e,FLOYD_STEINBERG_KERNEL)}function atkinsonDither(a,r,e){return errorDiffusionDither(a,r,e,ATKINSON_KERNEL)}function stuckiDither(a,r,e){return errorDiffusionDither(a,r,e,STUCKI_KERNEL)}function jarvisDither(a,r,e){return errorDiffusionDither(a,r,e,JARVIS_KERNEL)}function bayerDither(a,e,t){var o=a.width,l=a.height,n=a.data,i=[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],h=computeEdgeMap(a),M=otsuEdgeThreshold(h);for(let r=0;r<l;r++)for(let a=0;a<o;a++){var b=r*o+a,f=4*b,m=_srgbToLinear[n[f]],s=_srgbToLinear[n[1+f]],u=_srgbToLinear[n[2+f]],g=.2126*m+.7152*s+.0722*u,g=1-4*(Math.max(0,Math.min(1,g))-.5)*(Math.max(0,Math.min(1,g))-.5),b=h[b],g=(i[7&r][7&a]/64-.5)*(e*(.4+.6*g))*(M<b?.15+.85*(1-(b-M)/(1-M)):1)*.5,b=findClosestColor(_linearToSrgb[Math.min(4095,Math.max(0,4095*(m+g)+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*(s+g)+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*(u+g)+.5|0))],t);n[f]=b.r,n[1+f]=b.g,n[2+f]=b.b}return a}let BLUE_NOISE_64=new Uint16Array([2048,3584,512,3072,1536,4e3,256,2816,1024,3840,768,2560,1792,4064,128,3328,640,2304,1280,3712,384,2176,896,3456,1664,3200,448,2688,1408,3904,64,2944,1920,3136,960,2432,1728,3520,192,2048,1152,3648,576,2880,1600,3072,832,2240,3968,480,1344,2752,704,3264,1088,3776,320,1472,2624,3392,896,2112,1856,3584,1568,2496,128,3904,1216,2368,3648,640,1920,3456,1024,2176,3840,256,1664,2944,768,3200,2048,576,1792,3072,448,2688,1344,3136,1792,384,2560,1088,3520,512,2816,1408,3712,960,2240,3392,1536,832,2880,192,3776,704,2432,1600,3264,2752,3968,320,1152,2624,1856,3584,64,2112,1472,3328,576,2304,1024,3648,896,1280,2176,3840,640,1728,3456,256,2496,1088,3904,768,2816,1344,3072,2560,448,3200,1920,384,2944,512,2048,3136,1536,2688,3712,128,1664,3520,832,2368,1792,3392,1152,3648,2368,960,3264,1408,704,3968,1856,480,2240,3776,320,1472,2752,576,2624,192,1600,3520,768,2816,1280,3072,2112,1024,3456,640,2432,1088,3840,1920,3392,896,2176,3136,448,1856,3648,256,1536,2880,3200,1728,384,2560,3712,128,1344,2496,3904,1664,512,2304,3328,832,2048,3584,576,1408,2688,960,3072,2240,3768,704,1152,2752,3456,1088,2624,192,1792,3136,768,2432,1600,3904,320,1472,2880,3200,1920,384,2112,3712,640,1344,2944,3520,448,2176,1024,3648,2560,832]),_blueNoiseSize=64,_blueNoiseTile=null;function getBlueNoiseTile(){if(_blueNoiseTile)return _blueNoiseTile;let M=_blueNoiseSize,r=M*M;var e=new Float32Array(r),t=BLUE_NOISE_64.length;for(let a=0;a<r;a++){var o=2654435761*a+BLUE_NOISE_64[a%t];o=73244475*((o=73244475*(o>>>16^o))>>>16^o),o^=o>>>16,e[a]=(65535&o)/65535}var l=(e,t)=>{var o,l,n=t%M,i=t/M|0;let h=0;for(let r=-2;r<=2;r++)for(let a=-2;a<=2;a++)0===a&&0===r||(l=(n+a+M)%M,o=(i+r+M)%M,o=e[t]-e[o*M+l],l=1/(a*a+r*r),h+=o*o*l);return h};let n=42;for(let a=0;a<8;a++)for(let a=0;a<r;a++){var i,h=Math.floor((n=16807*n%2147483647)/2147483647*r);a!==h&&(i=l(e,a)+l(e,h),[e[a],e[h]]=[e[h],e[a]],l(e,a)+l(e,h)<i)&&([e[a],e[h]]=[e[h],e[a]])}return _blueNoiseTile=e}function blueNoiseDither(a,e,t){var o=a.width,l=a.height,n=a.data,i=getBlueNoiseTile(),h=_blueNoiseSize,M=computeEdgeMap(a),b=otsuEdgeThreshold(M);for(let r=0;r<l;r++)for(let a=0;a<o;a++){var f=r*o+a,m=4*f,s=_srgbToLinear[n[m]],u=_srgbToLinear[n[1+m]],g=_srgbToLinear[n[2+m]],v=.2126*s+.7152*u+.0722*g,v=1-4*(Math.max(0,Math.min(1,v))-.5)*(Math.max(0,Math.min(1,v))-.5),f=M[f],v=(i[r%h*h+a%h]-.5)*(e*(.4+.6*v))*(b<f?.15+.85*(1-(f-b)/(1-b)):1)*.5,f=findClosestColor(_linearToSrgb[Math.min(4095,Math.max(0,4095*(s+v)+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*(u+v)+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*(g+v)+.5|0))],t);n[m]=f.r,n[1+m]=f.g,n[2+m]=f.b}return a}function hilbertCurve(r){var e=[];var t=r*r;for(let a=0;a<t;a++)e.push(((a,r)=>{let e,t,o,l=0,n=0;for(o=1;o<a;o*=2)0==(t=1&(r^(e=1&(r/2|0))))&&(1==e&&(l=o-1-l,n=o-1-n),[l,n]=[n,l]),l+=o*e,n+=o*t,r=r/4|0;return[l,n]})(r,a));return e}function riemersmaDither(a,i,h){var r=a.width,e=a.height,M=a.data,t=r*e,o=Math.max(r,e);let l=2;for(;l<o;)l*=2;var n,b,f=[];for([n,b]of hilbertCurve(l))n<r&&b<e&&f.push(b*r+n);var m=computeEdgeMap(a),s=otsuEdgeThreshold(m),u=new Float32Array(t),g=new Float32Array(t),v=new Float32Array(t);for(let a=0;a<t;a++){var _=4*a;u[a]=_srgbToLinear[M[_]],g[a]=_srgbToLinear[M[1+_]],v[a]=_srgbToLinear[M[2+_]]}var T=1/Math.E,d=new Float32Array(16);let L=0;for(let a=0;a<16;a++)d[a]=Math.pow(T,a),L+=d[a];for(let a=0;a<16;a++)d[a]/=L;var c=new Float32Array(16),x=new Float32Array(16),C=new Float32Array(16);let w=0;for(let n=0;n<f.length;n++){var p=f[n];let r=0,e=0,t=0;for(let a=0;a<16;a++){var S=(w+a)%16;r+=c[S]*d[a],e+=x[S]*d[a],t+=C[S]*d[a]}var y=u[p]+r,E=g[p]+e,A=v[p]+t,R=findClosestColor(_linearToSrgb[Math.min(4095,Math.max(0,4095*y+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*E+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*A+.5|0))],h),U=4*p,U=(M[U]=R.r,M[1+U]=R.g,M[2+U]=R.b,m[p]),p=i*(s<U?.15+.85*(1-(U-s)/(1-s)):1);let a=(y-_srgbToLinear[R.r])*p,o=(E-_srgbToLinear[R.g])*p,l=(A-_srgbToLinear[R.b])*p;U=.2126*y+.7152*E+.0722*A,R=.3+.4*(1-4*(Math.max(0,Math.min(1,U))-.5)*(Math.max(0,Math.min(1,U))-.5));Math.abs(a)>R&&(a=R*Math.tanh(a/R)),Math.abs(o)>R&&(o=R*Math.tanh(o/R)),Math.abs(l)>R&&(l=R*Math.tanh(l/R)),c[w=(w+16-1)%16]=a,x[w]=o,C[w]=l}return a}function hybridDither(a,n,i){var h=a.width,M=a.height,b=a.data,r=h*M,e=getBlueNoiseTile(),t=_blueNoiseSize,f=computeEdgeMap(a),m=otsuEdgeThreshold(f),s=new Float32Array(r),u=new Float32Array(r),g=new Float32Array(r),v=new Float32Array(r);{var _=new Float32Array(r);for(let a=0;a<r;a++){var o=4*a;_[a]=.2126*_srgbToLinear[b[o]]+.7152*_srgbToLinear[b[1+o]]+.0722*_srgbToLinear[b[2+o]]}let a=0;for(let n=0;n<M;n++)for(let l=0;l<h;l++){var T=n*h+l;let e=0,t=0,o=0;for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){var d=n+r,L=l+a;0<=d&&d<M&&0<=L&&L<h&&(d=_[d*h+L],e+=d,t+=d*d,o++)}var c=e/o,c=t/o-c*c;(v[T]=c)>a&&(a=c)}if(0<a){var l=1/a;for(let a=0;a<r;a++)v[a]*=l}}for(let a=0;a<r;a++){var x=4*a,C=a%h,w=a/h|0,p=.2126*_srgbToLinear[b[x]]+.7152*_srgbToLinear[b[1+x]]+.0722*_srgbToLinear[b[2+x]],p=.5+.5*(1-4*(Math.max(0,Math.min(1,p))-.5)*(Math.max(0,Math.min(1,p))-.5)),p=(.2+.3*v[a])*p*n*.5,S=(e[w%t*t+C%t]-.5)*p,y=(e[(17+w)%t*t+(31+C)%t]-.5)*p,w=(e[(37+w)%t*t+(13+C)%t]-.5)*p;s[a]=_srgbToLinear[b[x]]+S,u[a]=_srgbToLinear[b[1+x]]+y,g[a]=_srgbToLinear[b[2+x]]+w}var E=FLOYD_STEINBERG_KERNEL,A=E.length;for(let l=0;l<M;l++){var R=1&l,P=R?-1:h,F=R?-1:1;for(let o=R?h-1:0;o!==P;o+=F){var U=l*h+o,D=findClosestColor(_linearToSrgb[Math.min(4095,Math.max(0,4095*s[U]+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*u[U]+.5|0))],_linearToSrgb[Math.min(4095,Math.max(0,4095*g[U]+.5|0))],i),B=4*U,B=(b[B]=D.r,b[1+B]=D.g,b[2+B]=D.b,f[U]);let a=1;m<B&&(a=.15+.85*(1-(B-m)/(1-m)));B=(.8-.3*v[U])*n*a;let r=(s[U]-_srgbToLinear[D.r])*B,e=(u[U]-_srgbToLinear[D.g])*B,t=(g[U]-_srgbToLinear[D.b])*B;D=.2126*s[U]+.7152*u[U]+.0722*g[U],B=.3+.4*(1-4*(Math.max(0,Math.min(1,D))-.5)*(Math.max(0,Math.min(1,D))-.5));Math.abs(r)>B&&(r=B*Math.tanh(r/B)),Math.abs(e)>B&&(e=B*Math.tanh(e/B)),Math.abs(t)>B&&(t=B*Math.tanh(t/B));for(let a=0;a<A;a++){var N=o+(R?-E[a][0]:E[a][0]),I=l+E[a][1];0<=N&&N<h&&0<=I&&I<M&&(I=I*h+N,N=E[a][2],s[I]+=r*N,u[I]+=e*N,g[I]+=t*N)}}}return a}function ditherImage(a,r,e,t){var o=analyzeImage(a),l=(adaptiveGammaCorrection(a),1+1.5*Math.max(0,1-o.dynamicRange)),l=(claheEnhance(a,l,8),.3+.5*Math.max(0,Math.min(1,1-4*o.stdY)));switch(unsharpMask(a,l,1),"fourColor"===t||"sixColor"===t?boostSaturation(a,1.1+.4*Math.max(0,Math.min(1,1-2*o.meanSat))):"threeColor"===t&&boostSaturation(a,1.05+.2*Math.max(0,Math.min(1,1-2*o.meanSat))),r){case"floydSteinberg":return floydSteinbergDither(a,e,t);case"atkinson":return atkinsonDither(a,e,t);case"stucki":return stuckiDither(a,e,t);case"jarvis":return jarvisDither(a,e,t);case"bayer":return bayerDither(a,e,t);case"blueNoise":return blueNoiseDither(a,e,t);case"riemersma":return riemersmaDither(a,e,t);case"hybrid":return hybridDither(a,e,t);default:return a}}let _sixColorMap={};for(let a of rgbPalette)_sixColorMap[a.value]=a;let _fourColorDecodeMap={0:{r:0,g:0,b:0},1:{r:255,g:255,b:255},2:{r:255,g:255,b:0},3:{r:255,g:0,b:0}};function decodeProcessedData(e,t,o,a){var r=new ImageData(t,o),l=r.data;if("sixColor"===a){var n=rgbPalette[5];for(let r=0;r<o;r++)for(let a=0;a<t;a++){var i=a*o+(o-1-r),i=_sixColorMap[e[i]]||n,h=4*(r*t+a);l[h]=i.r,l[1+h]=i.g,l[2+h]=i.b,l[3+h]=255}}else if("fourColor"===a){var M=_fourColorDecodeMap[1];for(let r=0;r<o;r++)for(let a=0;a<t;a++){var b=(r*t+a)/4|0,f=6-a%4*2,b=e[b]>>f&3,f=_fourColorDecodeMap[b]||M,b=4*(r*t+a);l[b]=f.r,l[1+b]=f.g,l[2+b]=f.b,l[3+b]=255}}else if("blackWhiteColor"===a){var m=Math.ceil(t/8);for(let r=0;r<o;r++)for(let a=0;a<t;a++){var s=r*m+Math.floor(a/8),u=7-a%8,s=e[s]>>u&1,u=4*(r*t+a);l[u]=s?255:0,l[1+u]=s?255:0,l[2+u]=s?255:0,l[3+u]=255}}else if("threeColor"===a){var g=Math.ceil(t/8),v=e.slice(0,g*o),_=e.slice(g*o);for(let r=0;r<o;r++)for(let a=0;a<t;a++){var T=r*g+Math.floor(a/8),d=7-a%8,L=v[T]>>d&1,T=_[T]>>d&1,d=4*(r*t+a);T?(l[d]=L?255:0,l[1+d]=L?255:0,l[2+d]=L?255:0):(l[d]=255,l[1+d]=0,l[2+d]=0),l[3+d]=255}}return r}function processImageData(a,e){var t=a.width,o=a.height,l=a.data;let n;if("sixColor"===e){n=new Uint8Array(t*o);for(let r=0;r<o;r++)for(let a=0;a<t;a++){var i=4*(r*t+a),i=findClosestColor(l[i],l[1+i],l[2+i],e),h=a*o+(o-1-r);n[h]=i.value}}else if("fourColor"===e){n=new Uint8Array(Math.ceil(t*o/4));for(let r=0;r<o;r++)for(let a=0;a<t;a++){var M=4*(r*t+a),M=findClosestColor(l[M],l[1+M],l[2+M],e),b=(r*t+a)/4|0,f=6-a%4*2;n[b]|=M.value<<f}}else if("blackWhiteColor"===e){var m=Math.ceil(t/8);n=new Uint8Array(m*o);for(let r=0;r<o;r++)for(let a=0;a<t;a++){var s=128<=l[4*(r*t+a)]?1:0,u=r*m+Math.floor(a/8),g=7-a%8;n[u]|=s<<g}}else if("threeColor"===e){var v=Math.ceil(t/8),_=new Uint8Array(o*v),T=new Uint8Array(o*v);for(let r=0;r<o;r++)for(let a=0;a<t;a++){var d=4*(r*t+a),L=l[d],c=l[1+d],d=l[2+d],x=r*v+Math.floor(a/8),C=7-a%8,w=200<L&&c<50&&d<50;200<L&&200<c&&200<d?(_[x]|=1<<C,T[x]|=1<<C):w||(T[x]|=1<<C)}(n=new Uint8Array(_.length+T.length)).set(_,0),n.set(T,_.length)}return n}